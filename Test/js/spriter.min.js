var Spriter;
(function (Spriter) {
    class IdNameMap {
        constructor() {
            this._items = [];
            this._itemNames = []; // keys are names and returned value is index into _tems array
        }
        // -------------------------------------------------------------------------
        add(item, id, name) {
            if (id === undefined) {
                id = this._items.length;
            }
            if (name === undefined || name === null) {
                name = "item_" + id;
            }
            this._items[id] = item;
            this._itemNames[name] = id;
        }
        // -------------------------------------------------------------------------
        getById(id) {
            return this._items[id];
        }
        // -------------------------------------------------------------------------
        getByName(name) {
            var id = this._itemNames[name];
            // TODO remove
            if (typeof id !== "number") {
                console.warn("item " + name + "  not found!");
            }
            return (typeof id === "number") ? this._items[id] : null;
        }
        // -------------------------------------------------------------------------
        get length() {
            return this._items.length;
        }
    }
    Spriter.IdNameMap = IdNameMap;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class LineStepper {
        // -------------------------------------------------------------------------
        constructor() {
            this.reset();
        }
        // -------------------------------------------------------------------------
        get current() {
            return this._line.at(this._currentIndex);
        }
        // -------------------------------------------------------------------------
        get currentIndex() {
            return this._currentIndex;
        }
        // -------------------------------------------------------------------------
        get next() {
            return this._line.at(this._nextIndex);
        }
        // -------------------------------------------------------------------------
        get nextIndex() {
            return this._nextIndex;
        }
        // -------------------------------------------------------------------------
        set lastTime(time) {
            this._lastTime = time;
        }
        // -------------------------------------------------------------------------
        set line(line) {
            this._line = line;
        }
        // -------------------------------------------------------------------------
        get line() {
            return this._line;
        }
        // -------------------------------------------------------------------------
        reset() {
            this._lastTime = -1;
            this._currentIndex = -1;
            this._nextIndex = 0;
        }
        // -------------------------------------------------------------------------
        step(time) {
            var index = this._nextIndex;
            // get key at current position
            var key = this._line.keys[index];
            var keyTime = key.time;
            // if current key time is bigger than time for stepTo, then we must first go till end of timeline and then continue from beginning
            var loop = time < this._lastTime;
            if ((!loop && (keyTime > this._lastTime && keyTime <= time)) ||
                (loop && (keyTime > this._lastTime || keyTime <= time))) {
                this._lastTime = keyTime;
                this._currentIndex = index;
                if ((++index) >= this._line.keys.length) {
                    index = 0;
                }
                this._nextIndex = index;
                return key;
            }
            return null;
        }
    }
    Spriter.LineStepper = LineStepper;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class NodeListBin {
        // -------------------------------------------------------------------------
        constructor(spriterBinFile, nodeList) {
            this._file = spriterBinFile;
            this._nodeList = nodeList;
        }
        // -------------------------------------------------------------------------
        length() {
            return this._nodeList.length;
        }
        // -------------------------------------------------------------------------
        processed() {
            this._file.processed();
        }
        // -------------------------------------------------------------------------
        getChildNodes(index, elementName) {
            return this._file.getNodesForElement(this._nodeList[index], elementName);
        }
        // -------------------------------------------------------------------------
        getFolder(index) {
            return this._file.getFolder(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getFile(index) {
            return this._file.getFile(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getTag(index) {
            return this._file.getTag(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getEntity(index) {
            return this._file.getEntity(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getObjectInfo(index) {
            return this._file.getObjectInfo(this._nodeList[index], index);
        }
        // -------------------------------------------------------------------------
        getCharMap(index) {
            return this._file.getCharMap(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(index, charMap, spriter) {
            this._file.getCharMapEntry(this._nodeList[index], charMap, spriter);
        }
        // -------------------------------------------------------------------------
        getVariable(index) {
            return this._file.getVariable(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getAnimation(index) {
            return this._file.getAnimation(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getMainline(index) {
            return this._file.getBaseline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getMainlineKey(index) {
            return this._file.getMainlineKey(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getRef(index) {
            return this._file.getRef(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getTimeline(index) {
            return this._file.getTimeline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getSoundline(index) {
            return this._file.getBaseline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getEventline(index) {
            return this._file.getBaseline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getTagline(index) {
            return this._file.getBaseline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getVarline(index) {
            return this._file.getVarline(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getKey(index) {
            return this._file.getKey(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getTagKey(index) {
            return this._file.getTagKey(this._nodeList[index]);
        }
        // -------------------------------------------------------------------------
        getVariableKey(index, type) {
            return this._file.getVariableKey(this._nodeList[index], type);
        }
        // -------------------------------------------------------------------------
        getTimelineKey(index, spriter) {
            return this._file.getTimelineKey(this._nodeList[index], index, spriter);
        }
        // -------------------------------------------------------------------------
        getTagChanges(spriter) {
            var tags = 0;
            for (var i = 0; i < this.length(); i++) {
                var tagIndex = this._file.getTagChange(this._nodeList[i]);
                tags |= (1 << tagIndex);
            }
            return tags;
        }
    }
    Spriter.NodeListBin = NodeListBin;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class NodeListJSON {
        // -------------------------------------------------------------------------
        constructor(spriterJSONFile, nodeList) {
            this._file = spriterJSONFile;
            this._nodeList = nodeList;
            if (!Array.isArray(nodeList)) {
                nodeList.length = 1;
            }
        }
        // -------------------------------------------------------------------------
        length() {
            return this._nodeList.length;
        }
        // -------------------------------------------------------------------------
        processed() {
            this._file.processed();
        }
        // -------------------------------------------------------------------------
        getNode(index) {
            if (Array.isArray(this._nodeList)) {
                return this._nodeList[index];
            }
            else {
                return this._nodeList;
            }
        }
        // -------------------------------------------------------------------------
        getChildNodes(index, elementName) {
            return this._file.getNodesForElement(this.getNode(index), elementName);
        }
        // -------------------------------------------------------------------------
        getFolder(index) {
            return this._file.getFolder(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getFile(index) {
            return this._file.getFile(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getTag(index) {
            return this._file.getTag(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getEntity(index) {
            return this._file.getEntity(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getObjectInfo(index) {
            return this._file.getObjectInfo(this.getNode(index), index);
        }
        // -------------------------------------------------------------------------
        getCharMap(index) {
            return this._file.getCharMap(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(index, charMap, spriter) {
            this._file.getCharMapEntry(this.getNode(index), charMap, spriter);
        }
        // -------------------------------------------------------------------------
        getVariable(index) {
            return this._file.getVariable(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getAnimation(index) {
            return this._file.getAnimation(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getMainline(index) {
            return this._file.getBaseline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getMainlineKey(index) {
            return this._file.getMainlineKey(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getRef(index) {
            return this._file.getRef(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getTimeline(index) {
            return this._file.getTimeline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getSoundline(index) {
            return this._file.getBaseline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getEventline(index) {
            return this._file.getBaseline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getTagline(index) {
            return this._file.getBaseline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getVarline(index) {
            return this._file.getVarline(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getKey(index) {
            return this._file.getKey(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getTagKey(index) {
            return this._file.getTagKey(this.getNode(index));
        }
        // -------------------------------------------------------------------------
        getVariableKey(index, type) {
            return this._file.getVariableKey(this.getNode(index), type);
        }
        // -------------------------------------------------------------------------
        getTimelineKey(index, spriter) {
            return this._file.getTimelineKey(this.getNode(index), index, spriter);
        }
        // -------------------------------------------------------------------------
        getTagChanges(spriter) {
            var tags = 0;
            for (var i = 0; i < this.length(); i++) {
                var tagIndex = this._file.getTagChange(this.getNode(i));
                tags |= (1 << tagIndex);
            }
            return tags;
        }
    }
    Spriter.NodeListJSON = NodeListJSON;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class NodeListXml {
        // -------------------------------------------------------------------------
        constructor(spriterXmlFile, nodeList) {
            this._file = spriterXmlFile;
            this._nodeList = nodeList;
        }
        // -------------------------------------------------------------------------
        length() {
            return this._nodeList.length;
        }
        // -------------------------------------------------------------------------
        processed() {
            this._file.processed();
        }
        // -------------------------------------------------------------------------
        getChildNodes(index, elementName) {
            return this._file.getNodesForElement(this._nodeList.item(index), elementName);
        }
        // -------------------------------------------------------------------------
        getFolder(index) {
            return this._file.getFolder(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getFile(index) {
            return this._file.getFile(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getTag(index) {
            return this._file.getTag(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getEntity(index) {
            return this._file.getEntity(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getObjectInfo(index) {
            return this._file.getObjectInfo(this._nodeList.item(index), index);
        }
        // -------------------------------------------------------------------------
        getCharMap(index) {
            return this._file.getCharMap(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(index, charMap, spriter) {
            this._file.getCharMapEntry(this._nodeList.item(index), charMap, spriter);
        }
        // -------------------------------------------------------------------------
        getVariable(index) {
            return this._file.getVariable(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getAnimation(index) {
            return this._file.getAnimation(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getMainline(index) {
            return this._file.getBaseline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getMainlineKey(index) {
            return this._file.getMainlineKey(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getRef(index) {
            return this._file.getRef(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getTimeline(index) {
            return this._file.getTimeline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getSoundline(index) {
            return this._file.getBaseline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getEventline(index) {
            return this._file.getBaseline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getTagline(index) {
            return this._file.getBaseline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getVarline(index) {
            return this._file.getVarline(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getKey(index) {
            return this._file.getKey(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getTagKey(index) {
            return this._file.getTagKey(this._nodeList.item(index));
        }
        // -------------------------------------------------------------------------
        getVariableKey(index, type) {
            return this._file.getVariableKey(this._nodeList.item(index), type);
        }
        // -------------------------------------------------------------------------
        getTimelineKey(index, spriter) {
            return this._file.getTimelineKey(this._nodeList.item(index), index, spriter);
        }
        // -------------------------------------------------------------------------
        getTagChanges(spriter) {
            var tags = 0;
            for (var i = 0; i < this.length(); i++) {
                var tagIndex = this._file.getTagChange(this._nodeList.item(i));
                tags |= (1 << tagIndex);
            }
            return tags;
        }
    }
    Spriter.NodeListXml = NodeListXml;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    let eFileType;
    (function (eFileType) {
        eFileType[eFileType["XML"] = 0] = "XML";
        eFileType[eFileType["JSON"] = 1] = "JSON";
        eFileType[eFileType["BIN"] = 2] = "BIN";
    })(eFileType = Spriter.eFileType || (Spriter.eFileType = {}));
    let eImageNameType;
    (function (eImageNameType) {
        eImageNameType[eImageNameType["ORIGINAL"] = 0] = "ORIGINAL";
        eImageNameType[eImageNameType["NAME_ONLY"] = 1] = "NAME_ONLY";
        eImageNameType[eImageNameType["NAME_AND_EXTENSION"] = 2] = "NAME_AND_EXTENSION";
        eImageNameType[eImageNameType["FULL_PATH_NO_EXTENSION"] = 3] = "FULL_PATH_NO_EXTENSION";
    })(eImageNameType = Spriter.eImageNameType || (Spriter.eImageNameType = {}));
    class SpriterFile {
        // -------------------------------------------------------------------------
        constructor(options) {
            let hasOptions = typeof options !== "undefined" && options !== null;
            // type of image names (path / name / extension)
            this._imageNameType = (hasOptions && typeof options.imageNameType !== "undefined") ? options.imageNameType : eImageNameType.NAME_ONLY;
            // min defs are present?
            this._minDefs = (hasOptions && typeof options.minDefs !== "undefined") ? options.minDefs : null;
        }
        // -------------------------------------------------------------------------
        processed() {
            this.popMinDefsStack();
        }
        // -------------------------------------------------------------------------
        setMinimized(minimized) {
            this._minimized = minimized;
            if (minimized) {
                this._minDefsStack = [];
                if (this._minDefs === null) {
                    console.error("Spriter file is minimized - you must provide object with name definitions");
                    return;
                }
            }
        }
        // -------------------------------------------------------------------------
        getFileName(path) {
            let name;
            switch (this._imageNameType) {
                case eImageNameType.NAME_ONLY:
                    name = (path.split('\\').pop().split('/').pop().split('.'))[0];
                    break;
                case eImageNameType.NAME_AND_EXTENSION:
                    name = path.split('\\').pop().split('/').pop();
                    break;
                case eImageNameType.FULL_PATH_NO_EXTENSION:
                    name = (path.split('.'))[0];
                    break;
                case eImageNameType.ORIGINAL:
                    name = path;
                    break;
            }
            return name;
        }
        // -------------------------------------------------------------------------
        translateElementName(elementName) {
            if (this._minimized) {
                if (this._minDefs["name"] !== elementName) {
                    console.warn("current definition is " + this._minDefs["name"]);
                    return elementName;
                }
                if (this._minDefs["minName"] !== null) {
                    elementName = this._minDefs["minName"];
                }
            }
            return elementName;
        }
        // -------------------------------------------------------------------------
        translateChildElementName(elementName) {
            if (this._minimized && this._minDefs !== null) {
                var elements = this._minDefs["childElements"];
                if (elements !== null) {
                    elementName = elements[elementName] === null ? elementName : elements[elementName]["minName"];
                }
            }
            return elementName;
        }
        // -------------------------------------------------------------------------
        translateAttributeName(attributeName) {
            if (this._minimized && this._minDefs !== null) {
                var attributes = this._minDefs["attributes"];
                if (attributes !== null) {
                    attributeName = attributes[attributeName] === null ? attributeName : attributes[attributeName];
                }
            }
            return attributeName;
        }
        // -------------------------------------------------------------------------
        setMinDefsToElementName(tagName) {
            if (this._minimized) {
                // save current level of min defs
                this._minDefsStack.push(this._minDefs);
                // get child definition and set it as current
                var minDef = this._minDefs["childElements"][tagName];
                this._minDefs = minDef;
            }
        }
        // -------------------------------------------------------------------------
        popMinDefsStack() {
            if (this._minimized) {
                this._minDefs = this._minDefsStack.pop();
            }
        }
    }
    Spriter.SpriterFile = SpriterFile;
})(Spriter || (Spriter = {}));
/// <reference path="SpriterFile.ts" />
var Spriter;
(function (Spriter) {
    class SpriterBin extends Spriter.SpriterFile {
        // -------------------------------------------------------------------------
        constructor(binData) {
            super(null);
            this._elements = {
                "spriter_data": 1,
                "folder": 2,
                "file": 3,
                "entity": 4,
                "obj_info": 5,
                "frames": 6,
                "i": 7,
                "animation": 8,
                "mainline": 9,
                "key": 10,
                "bone_ref": 11,
                "object_ref": 12,
                "timeline": 13,
                "bone": 14,
                "object": 15
            };
            this._smallOffset = false;
            this._bin = new DataView(binData);
            this._smallOffset = this._bin.getUint8(0) === 1;
        }
        // -------------------------------------------------------------------------
        getType() {
            return Spriter.eFileType.BIN;
        }
        // -------------------------------------------------------------------------
        readUint8() {
            return this._bin.getUint8(this._tmpPosition++);
        }
        // -------------------------------------------------------------------------
        readInt8() {
            return this._bin.getInt8(this._tmpPosition++);
        }
        // -------------------------------------------------------------------------
        readUint16() {
            var value = this._bin.getUint16(this._tmpPosition, true);
            this._tmpPosition += 2;
            return value;
        }
        // -------------------------------------------------------------------------
        readInt16() {
            var value = this._bin.getInt16(this._tmpPosition, true);
            this._tmpPosition += 2;
            return value;
        }
        // -------------------------------------------------------------------------
        readUint32() {
            var value = this._bin.getUint32(this._tmpPosition, true);
            this._tmpPosition += 4;
            return value;
        }
        // -------------------------------------------------------------------------
        readInt32() {
            var value = this._bin.getInt32(this._tmpPosition, true);
            this._tmpPosition += 4;
            return value;
        }
        // -------------------------------------------------------------------------
        readFixed16_16() {
            var value = this._bin.getInt32(this._tmpPosition, true);
            this._tmpPosition += 4;
            return value / 65536;
        }
        // -------------------------------------------------------------------------
        readFixed1_7() {
            var value = this._bin.getInt8(this._tmpPosition++) & 0xFF;
            return value / 128;
        }
        // -------------------------------------------------------------------------
        readString() {
            var chars = [];
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                chars.push(this._bin.getUint8(this._tmpPosition++));
            }
            return String.fromCharCode.apply(null, chars);
        }
        // -------------------------------------------------------------------------
        getNodes(nodeName) {
            return new Spriter.NodeListBin(this, this.getSubNodesOfElementType(1, this._elements[nodeName]));
        }
        // -------------------------------------------------------------------------
        getNodesForElement(elementPosition, nodeName) {
            return new Spriter.NodeListBin(this, this.getSubNodesOfElementType(elementPosition, this._elements[nodeName]));
        }
        // -------------------------------------------------------------------------
        getSubNodesOfElementType(positon, elementType) {
            var result = [];
            var subelementsCount = this._bin.getUint8(positon + 1);
            positon += 2;
            for (var i = 0; i < subelementsCount; i++) {
                var subelementOffset = this._smallOffset ? this._bin.getUint16(positon + i * 2, true) : this._bin.getUint32(positon + i * 4, true);
                var subelementType = this._bin.getUint8(positon + subelementOffset);
                if (subelementType === elementType) {
                    result.push(positon + subelementOffset);
                }
            }
            return result;
        }
        // -------------------------------------------------------------------------
        getAttribsPosition(position) {
            var subelementsCount = this._bin.getUint8(position + 1);
            return position + 2 + subelementsCount * (this._smallOffset ? 2 : 4);
        }
        // -------------------------------------------------------------------------
        getFolder(position) {
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var name = "";
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_FOLDER_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_FOLDER_NAME:
                        name = this.readString();
                        break;
                }
            }
            return new Spriter.Folder(id, name);
        }
        // -------------------------------------------------------------------------
        getFile(position) {
            console.log("skip sound loading");
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var name = "";
            var pivotX = 0;
            var pivotY = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_FILE_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_FILE_NAME:
                        name = this.readString();
                        break;
                    case SpriterBin.ATTR_FILE_PIVOT_X:
                        pivotX = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_FILE_PIVOT_Y:
                        pivotY = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_FILE_WIDTH:
                    case SpriterBin.ATTR_FILE_HEIGHT:
                        // ignore - just skip
                        this._tmpPosition += 2;
                        break;
                }
            }
            return new Spriter.File(id, this.getFileName(name), pivotX, 1 - pivotY);
        }
        // -------------------------------------------------------------------------
        getTag(position) {
            console.error("implement loading Tag");
            return null;
        }
        // -------------------------------------------------------------------------
        getEntity(position) {
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var name = "";
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_ENTITY_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_ENTITY_NAME:
                        name = this.readString();
                        break;
                }
            }
            return new Spriter.Entity(id, name);
        }
        // -------------------------------------------------------------------------
        getObjectInfo(position, index) {
            this._tmpPosition = this.getAttribsPosition(position);
            var name = "";
            var type = 0 /* SPRITE */;
            var width = 0;
            var height = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_OBJ_INFO_NAME:
                        name = this.readString();
                        break;
                    case SpriterBin.ATTR_OBJ_INFO_TYPE:
                        if (this.readUint8() === 1) {
                            type = 1 /* BONE */;
                        }
                        break;
                    case SpriterBin.ATTR_OBJ_INFO_WIDTH:
                        width = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_OBJ_INFO_HEIGHT:
                        height = this.readFixed16_16();
                        break;
                }
            }
            console.error("add loading of pivots");
            return new Spriter.ObjectInfo(index, name, type, width, height, 0, 0);
        }
        // -------------------------------------------------------------------------
        getCharMap(position) {
            console.error("add loading of charmaps");
            return null;
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(position, charMap, spriter) {
            console.error("add loading of charmap entries");
            return null;
        }
        // -------------------------------------------------------------------------
        getVariable(position) {
            console.error("add loading of variables");
            return null;
        }
        // -------------------------------------------------------------------------
        getAnimation(position) {
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var name = "";
            var length = 0;
            var interval = 0;
            var looping = Spriter.eAnimationLooping.LOOPING;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_ANIMATION_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_ANIMATION_NAME:
                        name = this.readString();
                        break;
                    case SpriterBin.ATTR_ANIMATION_LENGTH:
                        length = this.readUint32();
                        break;
                    case SpriterBin.ATTR_ANIMATION_INTERVAL:
                        // ignore - skip
                        this._tmpPosition += 2;
                        break;
                    case SpriterBin.ATTR_ANIMATION_LOOPING:
                        looping = (this.readUint8() === 1) ? Spriter.eAnimationLooping.LOOPING : Spriter.eAnimationLooping.NO_LOOPING;
                        break;
                }
            }
            return new Spriter.Animation(id, name, length, looping);
        }
        // -------------------------------------------------------------------------
        getMainlineKey(position) {
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var time = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_MAINLINE_KEY_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_MAINLINE_KEY_TIME:
                        time = this.readUint32();
                        break;
                }
            }
            return new Spriter.KeyMainline(id, time);
        }
        // -------------------------------------------------------------------------
        getRef(position) {
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var parent = -1;
            var timeline = 0;
            var key = 0;
            var z_index = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_BONE_REF_ID:
                    case SpriterBin.ATTR_OBJ_REF_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_BONE_REF_PARENT:
                    case SpriterBin.ATTR_OBJ_REF_PARENT:
                        parent = this.readUint8();
                        break;
                    case SpriterBin.ATTR_BONE_REF_TIMELINE:
                    case SpriterBin.ATTR_OBJ_REF_TIMELINE:
                        timeline = this.readUint8();
                        break;
                    case SpriterBin.ATTR_BONE_REF_KEY:
                    case SpriterBin.ATTR_OBJ_REF_KEY:
                        key = this.readUint8();
                        break;
                    case SpriterBin.ATTR_OBJ_REF_Z:
                        z_index = this.readUint8();
                        break;
                    case SpriterBin.ATTR_OBJ_REF_NAME:
                        // waste
                        this.readString();
                        break;
                    case SpriterBin.ATTR_OBJ_REF_FOLDER:
                    case SpriterBin.ATTR_OBJ_REF_FILE:
                        ++this._tmpPosition;
                        break;
                    case SpriterBin.ATTR_OBJ_REF_ABS_X:
                    case SpriterBin.ATTR_OBJ_REF_ABS_Y:
                    case SpriterBin.ATTR_OBJ_REF_ABS_PIVOT_X:
                    case SpriterBin.ATTR_OBJ_REF_ABS_PIVOT_Y:
                    case SpriterBin.ATTR_OBJ_REF_ABS_SCALE_X:
                    case SpriterBin.ATTR_OBJ_REF_ABS_SCALE_Y:
                    case SpriterBin.ATTR_OBJ_REF_ANGLE:
                        // skip
                        this._tmpPosition += 4;
                        break;
                    case SpriterBin.ATTR_OBJ_REF_ALPHA:
                        // skip
                        ++this._tmpPosition;
                        break;
                }
            }
            return new Spriter.Ref(id, parent, timeline, key, z_index);
        }
        // -------------------------------------------------------------------------
        getTimeline(position) {
            console.error("add loading of all types of objects");
            this._tmpPosition = this.getAttribsPosition(position);
            var id = 0;
            var name = "";
            var obj = 0;
            var type = 0 /* SPRITE */;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_TIMELINE_ID:
                        id = this.readUint8();
                        break;
                    case SpriterBin.ATTR_TIMELINE_NAME:
                        name = this.readString();
                        break;
                    case SpriterBin.ATTR_TIMELINE_OBJ:
                        obj = this.readUint8();
                        break;
                    case SpriterBin.ATTR_TIMELINE_OBJ_TYPE:
                        if (this.readUint8() === 1) {
                            type = 1 /* BONE */;
                        }
                        break;
                }
            }
            return new Spriter.Timeline(id, name, type, obj);
        }
        // -------------------------------------------------------------------------
        getBaseline(position) {
            console.error("add loading of baselines");
            return null;
        }
        // -------------------------------------------------------------------------
        getVarline(position) {
            console.error("add loading of varlines");
            return null;
        }
        // -------------------------------------------------------------------------
        getKey(position) {
            console.error("add loading of keys");
            return null;
        }
        // -------------------------------------------------------------------------
        getTagKey(position) {
            console.error("add loading of tag keys");
            return null;
        }
        // -------------------------------------------------------------------------
        getVariableKey(position, type) {
            console.error("add loading of variable keys");
            return null;
        }
        // -------------------------------------------------------------------------
        getTimelineKey(position, index, spriter) {
            this._tmpPosition = this.getAttribsPosition(position);
            var time = 0;
            var spin = 1;
            // curve and params
            var curve = 0 /* LINEAR */;
            var c1 = 0;
            var c2 = 0;
            var c3 = 0;
            var c4 = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_TIMELINE_KEY_ID:
                        // skip
                        ++this._tmpPosition;
                        break;
                    case SpriterBin.ATTR_TIMELINE_KEY_TIME:
                        time = this.readUint32();
                        break;
                    case SpriterBin.ATTR_TIMELINE_KEY_SPIN:
                        spin = this.readInt8();
                        break;
                    case SpriterBin.ATTR_TIMELINE_KEY_CURVE:
                        curve = this.readUint8();
                        break;
                    case SpriterBin.ATTR_TIMELINE_KEY_C1:
                        c1 = this.readFixed1_7();
                        break;
                    case SpriterBin.ATTR_TIMELINE_KEY_C2:
                        c2 = this.readFixed1_7();
                        break;
                }
            }
            // get child element
            position += 2;
            var offset = position + (this._smallOffset ? this._bin.getUint16(position, true) : this._bin.getUint32(position, true));
            var elementType = this._bin.getUint8(offset);
            var key = null;
            var keyDataElm = null;
            var sprite = false;
            if (elementType === 14 /* bone */) {
                key = new Spriter.KeyBone(index, time, spin);
            }
            else if (elementType === 15 /* object */) {
                key = new Spriter.KeyObject(index, time, spin);
                sprite = true;
            }
            // other curve than linear?
            if (curve !== 0 /* LINEAR */) {
                key.setCurve(curve, c1, c2, c3, c4);
            }
            this._tmpPosition = this.getAttribsPosition(offset);
            // spatial info
            var info = key.info;
            info.x = 0; //this.parseFloat(keyDataElm, "x");
            info.y = 0; //-this.parseFloat(keyDataElm, "y");
            info.scaleX = 1; // this.parseFloat(keyDataElm, "scale_x", 1);
            info.scaleY = 1; //this.parseFloat(keyDataElm, "scale_y", 1);
            info.angle = 0; //360 - this.parseFloat(keyDataElm, "angle");
            info.alpha = 1; //this.parseFloat(keyDataElm, "a", 1);
            var pivotX = 0;
            var hasPivotX = false;
            var pivotY = 0;
            var hasPivotY = false;
            var folder = 0;
            var file = 0;
            for (var i = this._bin.getUint8(this._tmpPosition++) - 1; i >= 0; i--) {
                switch (this._bin.getUint8(this._tmpPosition++)) {
                    case SpriterBin.ATTR_BONE_X:
                    case SpriterBin.ATTR_OBJ_X:
                        info.x = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_BONE_Y:
                    case SpriterBin.ATTR_OBJ_Y:
                        info.y = -this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_BONE_ANGLE:
                    case SpriterBin.ATTR_OBJ_ANGLE:
                        info.angle = 360 - this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_BONE_SCALE_X:
                    case SpriterBin.ATTR_OBJ_SCALE_X:
                        info.scaleX = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_BONE_SCALE_Y:
                    case SpriterBin.ATTR_OBJ_SCALE_Y:
                        info.scaleY = this.readFixed16_16();
                        break;
                    case SpriterBin.ATTR_OBJ_FOLDER:
                        folder = this.readUint8();
                        break;
                    case SpriterBin.ATTR_OBJ_FILE:
                        file = this.readUint8();
                        break;
                    case SpriterBin.ATTR_OBJ_PIVOT_X:
                        pivotX = this.readFixed16_16();
                        hasPivotX = true;
                        break;
                    case SpriterBin.ATTR_OBJ_PIVOT_Y:
                        pivotY = this.readFixed16_16();
                        hasPivotY = true;
                        break;
                    case SpriterBin.ATTR_OBJ_ALPHA:
                        info.alpha = this.readFixed1_7();
                        break;
                }
            }
            if (sprite) {
                key.setFolderAndFile(folder, file);
                // set pivot in spatial info different from default (based on pivot in file)
                var fileObj = spriter.getFolderById(folder).getFileById(file);
                info.pivotX = hasPivotX ? pivotX : fileObj.pivotX;
                // 1 - to flip Y, default anchor is already flipped, so it needs to be flipped back to avoid double flipping
                info.pivotY = 1 - (hasPivotY ? pivotY : 1 - fileObj.pivotY);
            }
            return key;
        }
        // -------------------------------------------------------------------------
        getTagChange(position) {
            console.error("add loading of tag changes");
            return null;
        }
    }
    // spriter data
    SpriterBin.ATTR_VERSION = 0;
    SpriterBin.ATTR_GENERATOR = 1;
    SpriterBin.ATTR_GENERATOR_VERSION = 2;
    // folder
    SpriterBin.ATTR_FOLDER_ID = 0;
    SpriterBin.ATTR_FOLDER_NAME = 1;
    // file
    SpriterBin.ATTR_FILE_ID = 0;
    SpriterBin.ATTR_FILE_NAME = 1;
    SpriterBin.ATTR_FILE_WIDTH = 2;
    SpriterBin.ATTR_FILE_HEIGHT = 3;
    SpriterBin.ATTR_FILE_PIVOT_X = 4;
    SpriterBin.ATTR_FILE_PIVOT_Y = 5;
    // entity
    SpriterBin.ATTR_ENTITY_ID = 0;
    SpriterBin.ATTR_ENTITY_NAME = 1;
    // obj_info
    SpriterBin.ATTR_OBJ_INFO_NAME = 0;
    SpriterBin.ATTR_OBJ_INFO_TYPE = 1;
    SpriterBin.ATTR_OBJ_INFO_WIDTH = 2;
    SpriterBin.ATTR_OBJ_INFO_HEIGHT = 3;
    // frames
    SpriterBin.ATTR_FRAMES_I_FOLDER = 0;
    SpriterBin.ATTR_FRAMES_I_FILE = 1;
    // animation
    SpriterBin.ATTR_ANIMATION_ID = 0;
    SpriterBin.ATTR_ANIMATION_NAME = 1;
    SpriterBin.ATTR_ANIMATION_LENGTH = 2;
    SpriterBin.ATTR_ANIMATION_INTERVAL = 3;
    SpriterBin.ATTR_ANIMATION_LOOPING = 4;
    // key
    SpriterBin.ATTR_MAINLINE_KEY_ID = 0;
    SpriterBin.ATTR_MAINLINE_KEY_TIME = 1;
    // bone_ref
    SpriterBin.ATTR_BONE_REF_ID = 0;
    SpriterBin.ATTR_BONE_REF_PARENT = 1;
    SpriterBin.ATTR_BONE_REF_TIMELINE = 2;
    SpriterBin.ATTR_BONE_REF_KEY = 3;
    // object_ref
    SpriterBin.ATTR_OBJ_REF_ID = 4;
    SpriterBin.ATTR_OBJ_REF_PARENT = 5;
    SpriterBin.ATTR_OBJ_REF_TIMELINE = 6;
    SpriterBin.ATTR_OBJ_REF_KEY = 7;
    SpriterBin.ATTR_OBJ_REF_NAME = 8;
    SpriterBin.ATTR_OBJ_REF_Z = 9;
    SpriterBin.ATTR_OBJ_REF_FOLDER = 10;
    SpriterBin.ATTR_OBJ_REF_FILE = 11;
    SpriterBin.ATTR_OBJ_REF_ABS_X = 12;
    SpriterBin.ATTR_OBJ_REF_ABS_Y = 13;
    SpriterBin.ATTR_OBJ_REF_ABS_PIVOT_X = 14;
    SpriterBin.ATTR_OBJ_REF_ABS_PIVOT_Y = 15;
    SpriterBin.ATTR_OBJ_REF_ABS_SCALE_X = 16;
    SpriterBin.ATTR_OBJ_REF_ABS_SCALE_Y = 17;
    SpriterBin.ATTR_OBJ_REF_ANGLE = 18;
    SpriterBin.ATTR_OBJ_REF_ALPHA = 19;
    // timeline
    SpriterBin.ATTR_TIMELINE_ID = 0;
    SpriterBin.ATTR_TIMELINE_NAME = 1;
    SpriterBin.ATTR_TIMELINE_OBJ = 2;
    SpriterBin.ATTR_TIMELINE_OBJ_TYPE = 3;
    // key
    SpriterBin.ATTR_TIMELINE_KEY_ID = 0;
    SpriterBin.ATTR_TIMELINE_KEY_TIME = 1;
    SpriterBin.ATTR_TIMELINE_KEY_SPIN = 2;
    SpriterBin.ATTR_TIMELINE_KEY_CURVE = 3;
    SpriterBin.ATTR_TIMELINE_KEY_C1 = 4;
    SpriterBin.ATTR_TIMELINE_KEY_C2 = 5;
    // bone
    SpriterBin.ATTR_BONE_X = 0;
    SpriterBin.ATTR_BONE_Y = 1;
    SpriterBin.ATTR_BONE_ANGLE = 2;
    SpriterBin.ATTR_BONE_SCALE_X = 3;
    SpriterBin.ATTR_BONE_SCALE_Y = 4;
    // object
    SpriterBin.ATTR_OBJ_FOLDER = 5;
    SpriterBin.ATTR_OBJ_FILE = 6;
    SpriterBin.ATTR_OBJ_X = 7;
    SpriterBin.ATTR_OBJ_Y = 8;
    SpriterBin.ATTR_OBJ_SCALE_X = 9;
    SpriterBin.ATTR_OBJ_SCALE_Y = 10;
    SpriterBin.ATTR_OBJ_PIVOT_X = 11;
    SpriterBin.ATTR_OBJ_PIVOT_Y = 12;
    SpriterBin.ATTR_OBJ_ANGLE = 13;
    SpriterBin.ATTR_OBJ_ALPHA = 14;
    Spriter.SpriterBin = SpriterBin;
})(Spriter || (Spriter = {}));
/// <reference path="SpriterFile.ts" />
var Spriter;
(function (Spriter) {
    class SpriterJSON extends Spriter.SpriterFile {
        // -------------------------------------------------------------------------
        constructor(JSONData, options) {
            super(options);
            this._json = JSONData;
            var minimized = JSONData["min"] !== undefined;
            this.setMinimized(minimized);
        }
        // -------------------------------------------------------------------------
        getType() {
            return Spriter.eFileType.JSON;
        }
        // -------------------------------------------------------------------------
        parseInt(element, attributeName, defaultValue = 0) {
            var value = element[this.translateAttributeName(attributeName)];
            if (value === undefined) {
                return defaultValue;
            }
            return typeof (value) === "number" ? value : parseInt(value);
        }
        // -------------------------------------------------------------------------
        parseFloat(element, attributeName, defaultValue = 0) {
            var value = element[this.translateAttributeName(attributeName)];
            if (value === undefined) {
                return defaultValue;
            }
            return typeof (value) === "number" ? value : parseFloat(value);
        }
        // -------------------------------------------------------------------------
        parseBoolean(element, attributeName, defaultValue = false) {
            var value = element[this.translateAttributeName(attributeName)];
            if (value === undefined) {
                return defaultValue;
            }
            return typeof (value) === "boolean" ? value : (value === "true");
        }
        // -------------------------------------------------------------------------
        parseString(element, attributeName, defaultValue = "") {
            var value = element[this.translateAttributeName(attributeName)];
            return value === undefined ? defaultValue : value;
        }
        // -------------------------------------------------------------------------
        getNodes(nodeName) {
            this.setMinDefsToElementName(nodeName);
            var translatedName = this.translateElementName(nodeName);
            return new Spriter.NodeListJSON(this, (this._json[translatedName] !== undefined) ? this._json[translatedName] : []);
        }
        // -------------------------------------------------------------------------
        getNodesForElement(element, nodeName) {
            this.setMinDefsToElementName(nodeName);
            var translatedName = this.translateElementName(nodeName);
            return new Spriter.NodeListJSON(this, (element[translatedName] !== undefined) ? element[translatedName] : []);
        }
        // -------------------------------------------------------------------------
        getFolder(element) {
            return new Spriter.Folder(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getFile(element) {
            if (element["type"] !== undefined && element["type"] === "sound") {
                return null;
            }
            return new Spriter.File(this.parseInt(element, "id"), this.getFileName(this.parseString(element, "name")), this.parseFloat(element, "pivot_x"), 1 - this.parseFloat(element, "pivot_y"), this.parseBoolean(element, "empty"));
        }
        // -------------------------------------------------------------------------
        getTag(element) {
            return new Spriter.Item(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getEntity(element) {
            return new Spriter.Entity(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getObjectInfo(element, index) {
            return new Spriter.ObjectInfo(index, this.parseString(element, "name"), Spriter.Types.getObjectTypeForName(this.parseString(element, "type")), this.parseFloat(element, "w"), this.parseFloat(element, "h"), this.parseFloat(element, "pivot_x"), this.parseFloat(element, "pivot_y"));
        }
        // -------------------------------------------------------------------------
        getCharMap(element) {
            return new Spriter.CharMap(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(element, charMap, spriter) {
            var sourceName = spriter.getFolderById(this.parseInt(element, "folder")).
                getFileById(this.parseInt(element, "file")).name;
            var target = null;
            if (element["target_folder"] !== undefined && element["target_file"] !== undefined) {
                target = spriter.getFolderById(this.parseInt(element, "target_folder")).
                    getFileById(this.parseInt(element, "target_file"));
            }
            charMap.put(sourceName, target);
        }
        // -------------------------------------------------------------------------
        getVariable(element) {
            var type = Spriter.Types.getVariableTypeForName(this.parseString(element, "type"));
            return new Spriter.Variable(this.parseInt(element, "id"), this.parseString(element, "name"), type, (type === 2 /* STRING */) ? this.parseString(element, "default") : this.parseFloat(element, "default", 0));
        }
        // -------------------------------------------------------------------------
        getAnimation(element) {
            return new Spriter.Animation(this.parseInt(element, "id"), this.parseString(element, "name"), this.parseFloat(element, "length"), this.parseBoolean(element, "looping", true) === true ? Spriter.eAnimationLooping.LOOPING : Spriter.eAnimationLooping.NO_LOOPING);
        }
        // -------------------------------------------------------------------------
        getMainlineKey(element) {
            return new Spriter.KeyMainline(this.parseInt(element, "id"), this.parseFloat(element, "time"));
        }
        // -------------------------------------------------------------------------
        getRef(element) {
            return new Spriter.Ref(this.parseInt(element, "id"), this.parseInt(element, "parent", -1), this.parseInt(element, "timeline"), this.parseInt(element, "key"), this.parseInt(element, "z_index"));
        }
        // -------------------------------------------------------------------------
        getTimeline(element) {
            return new Spriter.Timeline(this.parseInt(element, "id"), this.parseString(element, "name"), Spriter.Types.getObjectTypeForName(this.parseString(element, "object_type", "sprite")), this.parseInt(element, "obj", -1));
        }
        // -------------------------------------------------------------------------
        getBaseline(element) {
            return new Spriter.Baseline(this.parseInt(element, "id"), this.parseString(element, "name", null));
        }
        // -------------------------------------------------------------------------
        getVarline(element) {
            return new Spriter.Varline(this.parseInt(element, "id"), this.parseInt(element, "def"));
        }
        // -------------------------------------------------------------------------
        getKey(element) {
            return new Spriter.Key(this.parseInt(element, "id"), this.parseInt(element, "time"));
        }
        // -------------------------------------------------------------------------
        getTagKey(element) {
            return new Spriter.KeyTag(this.parseInt(element, "id"), this.parseInt(element, "time"));
        }
        // -------------------------------------------------------------------------
        getVariableKey(element, type) {
            return new Spriter.KeyVariable(this.parseInt(element, "id"), this.parseInt(element, "time"), (type === 2 /* STRING */) ? this.parseString(element, "val") : this.parseFloat(element, "val"));
        }
        // -------------------------------------------------------------------------
        getTimelineKey(element, index, spriter) {
            var time = this.parseInt(element, "time");
            var spin = this.parseInt(element, "spin", 1);
            // curve and params
            var curve = this.parseString(element, "curve_type", "linear");
            var c1 = this.parseFloat(element, "c1", 0);
            var c2 = this.parseFloat(element, "c2", 0);
            var c3 = this.parseFloat(element, "c3", 0);
            var c4 = this.parseFloat(element, "c4", 0);
            // sprite or bone key?
            var boneTag = this.translateChildElementName("bone");
            var objectTag = this.translateChildElementName("object");
            var key = null;
            var keyDataElm = null;
            var sprite = false;
            if (element[boneTag] !== undefined) {
                keyDataElm = element[boneTag];
                key = new Spriter.KeyBone(index, time, spin);
                this.setMinDefsToElementName("bone");
            }
            else if (element[objectTag] !== undefined) {
                keyDataElm = element[objectTag];
                key = new Spriter.KeyObject(index, time, spin);
                this.setMinDefsToElementName("object");
                sprite = true;
            }
            // other curve than linear?
            if (curve !== "linear") {
                key.setCurve(Spriter.Types.getCurveTypeForName(curve), c1, c2, c3, c4);
            }
            // spatial info
            var info = key.info;
            info.x = this.parseFloat(keyDataElm, "x");
            info.y = -this.parseFloat(keyDataElm, "y");
            info.scaleX = this.parseFloat(keyDataElm, "scale_x", 1);
            info.scaleY = this.parseFloat(keyDataElm, "scale_y", 1);
            info.angle = 360 - this.parseFloat(keyDataElm, "angle");
            info.alpha = this.parseFloat(keyDataElm, "a", 1);
            if (sprite) {
                // sprite specific - set file and folder
                var folderId = this.parseInt(keyDataElm, "folder");
                var fileId = this.parseInt(keyDataElm, "file");
                key.setFolderAndFile(folderId, fileId);
                // set pivot in spatial info different from default (based on pivot in file)
                var file = spriter.getFolderById(folderId).getFileById(fileId);
                info.pivotX = this.parseFloat(keyDataElm, "pivot_x", file.pivotX);
                // 1 - to flip Y, default anchor is already flipped, so it needs to be flipped back to avoid double flipping
                info.pivotY = 1 - this.parseFloat(keyDataElm, "pivot_y", 1 - file.pivotY);
            }
            this.popMinDefsStack();
            return key;
        }
        // -------------------------------------------------------------------------
        getTagChange(element) {
            return this.parseInt(element, "t");
        }
    }
    Spriter.SpriterJSON = SpriterJSON;
})(Spriter || (Spriter = {}));
/// <reference path="SpriterFile.ts" />
var Spriter;
(function (Spriter) {
    class SpriterXml extends Spriter.SpriterFile {
        // -------------------------------------------------------------------------
        constructor(xmlData, options) {
            super(options);
            this._xml = xmlData;
            var minimized = xmlData.documentElement.hasAttribute("min");
            this.setMinimized(minimized);
        }
        // -------------------------------------------------------------------------
        getType() {
            return Spriter.eFileType.XML;
        }
        // -------------------------------------------------------------------------
        parseInt(element, attributeName, defaultValue = 0) {
            var value = element.getAttribute(this.translateAttributeName(attributeName));
            return value !== null ? parseInt(value) : defaultValue;
        }
        // -------------------------------------------------------------------------
        parseFloat(element, attributeName, defaultValue = 0) {
            var value = element.getAttribute(this.translateAttributeName(attributeName));
            return value !== null ? parseFloat(value) : defaultValue;
        }
        // -------------------------------------------------------------------------
        parseString(element, attributeName, defaultValue = "") {
            var value = element.getAttribute(this.translateAttributeName(attributeName));
            return value !== null ? value : defaultValue;
        }
        // -------------------------------------------------------------------------
        getNodes(nodeName) {
            this.setMinDefsToElementName(nodeName);
            var translatedName = this.translateElementName(nodeName);
            return new Spriter.NodeListXml(this, this._xml.documentElement.getElementsByTagName(translatedName));
        }
        // -------------------------------------------------------------------------
        getNodesForElement(element, nodeName) {
            this.setMinDefsToElementName(nodeName);
            var translatedName = this.translateElementName(nodeName);
            return new Spriter.NodeListXml(this, element.getElementsByTagName(translatedName));
        }
        // -------------------------------------------------------------------------
        getFolder(element) {
            return new Spriter.Folder(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getFile(element) {
            if (element.hasAttribute("type") && element.getAttribute("type") === "sound") {
                return null;
            }
            return new Spriter.File(this.parseInt(element, "id"), this.getFileName(this.parseString(element, "name")), this.parseFloat(element, "pivot_x"), 1 - this.parseFloat(element, "pivot_y"));
        }
        // -------------------------------------------------------------------------
        getTag(element) {
            return new Spriter.Item(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getEntity(element) {
            return new Spriter.Entity(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getObjectInfo(element, index) {
            return new Spriter.ObjectInfo(index, this.parseString(element, "name"), Spriter.Types.getObjectTypeForName(this.parseString(element, "type")), this.parseFloat(element, "w"), this.parseFloat(element, "h"), this.parseFloat(element, "pivot_x"), this.parseFloat(element, "pivot_y"));
        }
        // -------------------------------------------------------------------------
        getCharMap(element) {
            return new Spriter.CharMap(this.parseInt(element, "id"), this.parseString(element, "name"));
        }
        // -------------------------------------------------------------------------
        getCharMapEntry(element, charMap, spriter) {
            var sourceName = spriter.getFolderById(this.parseInt(element, "folder")).
                getFileById(this.parseInt(element, "file")).name;
            var target = null;
            if (element.hasAttribute("target_folder") && element.hasAttribute("target_file")) {
                target = spriter.getFolderById(this.parseInt(element, "target_folder")).
                    getFileById(this.parseInt(element, "target_file"));
            }
            charMap.put(sourceName, target);
        }
        // -------------------------------------------------------------------------
        getVariable(element) {
            var type = Spriter.Types.getVariableTypeForName(this.parseString(element, "type"));
            return new Spriter.Variable(this.parseInt(element, "id"), this.parseString(element, "name"), type, (type === 2 /* STRING */) ? this.parseString(element, "default") : this.parseFloat(element, "default", 0));
        }
        // -------------------------------------------------------------------------
        getAnimation(element) {
            return new Spriter.Animation(this.parseInt(element, "id"), this.parseString(element, "name"), this.parseFloat(element, "length"), this.parseString(element, "looping", "true") === "true" ? Spriter.eAnimationLooping.LOOPING : Spriter.eAnimationLooping.NO_LOOPING);
        }
        // -------------------------------------------------------------------------
        getMainlineKey(element) {
            return new Spriter.KeyMainline(this.parseInt(element, "id"), this.parseFloat(element, "time"));
        }
        // -------------------------------------------------------------------------
        getRef(element) {
            return new Spriter.Ref(this.parseInt(element, "id"), this.parseInt(element, "parent", -1), this.parseInt(element, "timeline"), this.parseInt(element, "key"), this.parseInt(element, "z_index"));
        }
        // -------------------------------------------------------------------------
        getTimeline(element) {
            return new Spriter.Timeline(this.parseInt(element, "id"), this.parseString(element, "name"), Spriter.Types.getObjectTypeForName(this.parseString(element, "object_type", "sprite")), this.parseInt(element, "obj", -1));
        }
        // -------------------------------------------------------------------------
        getBaseline(element) {
            return new Spriter.Baseline(this.parseInt(element, "id"), this.parseString(element, "name", null));
        }
        // -------------------------------------------------------------------------
        getVarline(element) {
            return new Spriter.Varline(this.parseInt(element, "id"), this.parseInt(element, "def"));
        }
        // -------------------------------------------------------------------------
        getKey(element) {
            return new Spriter.Key(this.parseInt(element, "id"), this.parseInt(element, "time"));
        }
        // -------------------------------------------------------------------------
        getTagKey(element) {
            return new Spriter.KeyTag(this.parseInt(element, "id"), this.parseInt(element, "time"));
        }
        // -------------------------------------------------------------------------
        getVariableKey(element, type) {
            return new Spriter.KeyVariable(this.parseInt(element, "id"), this.parseInt(element, "time"), (type === 2 /* STRING */) ? this.parseString(element, "val") : this.parseFloat(element, "val"));
        }
        // -------------------------------------------------------------------------
        getTimelineKey(element, index, spriter) {
            var time = this.parseInt(element, "time");
            var spin = this.parseInt(element, "spin", 1);
            // curve and params
            var curve = this.parseString(element, "curve_type", "linear");
            var c1 = this.parseFloat(element, "c1", 0);
            var c2 = this.parseFloat(element, "c2", 0);
            var c3 = this.parseFloat(element, "c3", 0);
            var c4 = this.parseFloat(element, "c4", 0);
            // sprite or bone key?
            var boneTag = this.translateChildElementName("bone");
            var objectTag = this.translateChildElementName("object");
            var key = null;
            var keyDataElm = (element.firstElementChild);
            var sprite = false;
            if (keyDataElm.tagName === boneTag) {
                key = new Spriter.KeyBone(index, time, spin);
                this.setMinDefsToElementName("bone");
            }
            else if (keyDataElm.tagName === objectTag) {
                this.setMinDefsToElementName("object");
                key = new Spriter.KeyObject(index, time, spin);
                sprite = true;
            }
            // other curve than linear?
            if (curve !== "linear") {
                key.setCurve(Spriter.Types.getCurveTypeForName(curve), c1, c2, c3, c4);
            }
            // spatial info
            var info = key.info;
            info.x = this.parseFloat(keyDataElm, "x");
            info.y = -this.parseFloat(keyDataElm, "y");
            info.scaleX = this.parseFloat(keyDataElm, "scale_x", 1);
            info.scaleY = this.parseFloat(keyDataElm, "scale_y", 1);
            info.angle = 360 - this.parseFloat(keyDataElm, "angle");
            info.alpha = this.parseFloat(keyDataElm, "a", 1);
            if (sprite) {
                // sprite specific - set file and folder
                var folderId = this.parseInt(keyDataElm, "folder");
                var fileId = this.parseInt(keyDataElm, "file");
                key.setFolderAndFile(folderId, fileId);
                // set pivot in spatial info different from default (based on pivot in file)
                var file = spriter.getFolderById(folderId).getFileById(fileId);
                info.pivotX = this.parseFloat(keyDataElm, "pivot_x", file.pivotX);
                // 1 - to flip Y, default anchor is already flipped, so it needs to be flipped back to avoid double flipping
                info.pivotY = 1 - this.parseFloat(keyDataElm, "pivot_y", 1 - file.pivotY);
            }
            this.popMinDefsStack();
            return key;
        }
        // -------------------------------------------------------------------------
        getTagChange(element) {
            return this.parseInt(element, "t");
        }
    }
    Spriter.SpriterXml = SpriterXml;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Item {
        // -------------------------------------------------------------------------
        constructor(id, name) {
            this._id = id;
            this._name = name;
        }
        // -------------------------------------------------------------------------
        get id() {
            return this._id;
        }
        // -------------------------------------------------------------------------
        get name() {
            return this._name;
        }
    }
    Spriter.Item = Item;
})(Spriter || (Spriter = {}));
/// <reference path="../IdNameMap.ts" />
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    let eAnimationLooping;
    (function (eAnimationLooping) {
        eAnimationLooping[eAnimationLooping["NO_LOOPING"] = 0] = "NO_LOOPING";
        eAnimationLooping[eAnimationLooping["LOOPING"] = 1] = "LOOPING";
    })(eAnimationLooping = Spriter.eAnimationLooping || (Spriter.eAnimationLooping = {}));
    ;
    class Animation extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name, length, loopType) {
            super(id, name);
            this._length = length;
            this._loopType = loopType;
            this._timelines = new Spriter.IdNameMap();
            this._lines = new Spriter.IdNameMap();
        }
        // -------------------------------------------------------------------------
        get mainline() {
            return this._mainline;
        }
        // -------------------------------------------------------------------------
        set mainline(mainline) {
            this._mainline = mainline;
        }
        // -------------------------------------------------------------------------
        addTimeline(timeline) {
            this._timelines.add(timeline, timeline.id, timeline.name);
        }
        // -------------------------------------------------------------------------
        getTimelineById(id) {
            return this._timelines.getById(id);
        }
        // -------------------------------------------------------------------------
        getTimelineByName(name) {
            return this._timelines.getByName(name);
        }
        // -------------------------------------------------------------------------
        addLine(line) {
            this._lines.add(line, this._lines.length, line.name);
        }
        // -------------------------------------------------------------------------
        getLineById(id) {
            return this._lines.getById(id);
        }
        // -------------------------------------------------------------------------
        getLineByName(name) {
            return this._lines.getByName(name);
        }
        // -------------------------------------------------------------------------
        get linesLength() {
            return this._lines.length;
        }
        // -------------------------------------------------------------------------
        get length() {
            return this._length;
        }
        // -------------------------------------------------------------------------
        get loopType() {
            return this._loopType;
        }
    }
    Spriter.Animation = Animation;
})(Spriter || (Spriter = {}));
/// <reference path="../IdNameMap.ts" />
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class Entity extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name) {
            super(id, name);
            this._objectInfos = new Spriter.IdNameMap();
            this._charMaps = new Spriter.IdNameMap();
            this._variables = new Spriter.IdNameMap();
            this._animations = new Spriter.IdNameMap();
        }
        // -------------------------------------------------------------------------
        addObjectInfo(objectInfo) {
            this._objectInfos.add(objectInfo, objectInfo.id, objectInfo.name);
        }
        // -------------------------------------------------------------------------
        getObjectInfoById(id) {
            return this._objectInfos.getById(id);
        }
        // -------------------------------------------------------------------------
        getObjectInfoByName(name) {
            return this._objectInfos.getByName(name);
        }
        // -------------------------------------------------------------------------
        addCharMap(charMap) {
            this._charMaps.add(charMap, charMap.id, charMap.name);
        }
        // -------------------------------------------------------------------------
        getCharMapById(id) {
            return this._charMaps.getById(id);
        }
        // -------------------------------------------------------------------------
        getCharMapByName(name) {
            return this._charMaps.getByName(name);
        }
        // -------------------------------------------------------------------------
        get charMapsLength() {
            return this._charMaps.length;
        }
        // -------------------------------------------------------------------------
        addVariable(variable) {
            this._variables.add(variable, variable.id, variable.name);
        }
        // -------------------------------------------------------------------------
        getVariableById(id) {
            return this._variables.getById(id);
        }
        // -------------------------------------------------------------------------
        getVariableByName(name) {
            return this._variables.getByName(name);
        }
        // -------------------------------------------------------------------------
        get variablesLength() {
            return this._variables.length;
        }
        // -------------------------------------------------------------------------
        addAnimation(animation) {
            this._animations.add(animation, animation.id, animation.name);
        }
        // -------------------------------------------------------------------------
        getAnimationById(id) {
            return this._animations.getById(id);
        }
        // -------------------------------------------------------------------------
        getAnimationByName(name) {
            return this._animations.getByName(name);
        }
        // -------------------------------------------------------------------------
        get animationsLength() {
            return this._animations.length;
        }
    }
    Spriter.Entity = Entity;
})(Spriter || (Spriter = {}));
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class File extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name, pivotX, pivotY, isEmpty = false) {
            super(id, name);
            this._pivotX = pivotX;
            this._pivotY = pivotY;
            this._isEmpty = isEmpty;
        }
        // -------------------------------------------------------------------------
        get pivotX() {
            return this._pivotX;
        }
        // -------------------------------------------------------------------------
        get isEmpty() {
            return this._isEmpty;
        }
        // -------------------------------------------------------------------------
        get pivotY() {
            return this._pivotY;
        }
    }
    Spriter.File = File;
})(Spriter || (Spriter = {}));
/// <reference path="../IdNameMap.ts" />
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class Folder extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name) {
            super(id, name);
            this._files = new Spriter.IdNameMap();
        }
        // -------------------------------------------------------------------------
        addFile(file) {
            this._files.add(file, file.id, file.name);
        }
        // -------------------------------------------------------------------------
        getFileById(id) {
            return this._files.getById(id);
        }
        // -------------------------------------------------------------------------
        getFileByName(name) {
            return this._files.getByName(name);
        }
    }
    Spriter.Folder = Folder;
})(Spriter || (Spriter = {}));
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class CharMap extends Spriter.Item {
        // -------------------------------------------------------------------------
        put(key, value) {
            if (this._map === undefined) {
                this._map = {};
            }
            if (this._map[key] !== undefined) {
                console.error("Key with name " + key + " already exists");
            }
            this._map[key] = value;
        }
        // -------------------------------------------------------------------------
        value(key) {
            return this._map[key];
        }
    }
    Spriter.CharMap = CharMap;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class CharMapStack {
        // -------------------------------------------------------------------------
        constructor(entity) {
            this._stack = [];
            this._length = 0;
            this._entity = entity;
        }
        // -------------------------------------------------------------------------
        reset() {
            this._length = 0;
        }
        // -------------------------------------------------------------------------
        push(charMapName) {
            var charMap = this.getCharMap(charMapName);
            this._stack[this._length++] = charMap;
        }
        // -------------------------------------------------------------------------
        remove(charMapName) {
            var charMap = this.getCharMap(charMapName);
            var index = this.findCharMap(charMap);
            // shift all items down
            if (index !== -1) {
                for (var i = index; i < this._length - 2; i++) {
                    this._stack[i] = this._stack[i + 1];
                }
                this._stack[--this._length] = null;
            }
        }
        // -------------------------------------------------------------------------
        getFile(file) {
            for (var i = this._length - 1; i >= 0; i--) {
                var value = this._stack[i].value(file.name);
                if (value !== undefined) {
                    return value;
                }
            }
            return file;
        }
        // -------------------------------------------------------------------------
        getCharMap(charMapName) {
            var charMap = this._entity.getCharMapByName(charMapName);
            if (charMapName === null) {
                console.error("charmap with name " + charMapName + " does not exist");
            }
            return charMap;
        }
        // -------------------------------------------------------------------------
        findCharMap(charMap) {
            for (var i = 0; i < this._length; i++) {
                if (this._stack[i] === charMap) {
                    return i;
                }
            }
            return -1;
        }
    }
    Spriter.CharMapStack = CharMapStack;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Key {
        // -------------------------------------------------------------------------
        constructor(id, time) {
            this._id = id;
            this._time = time;
        }
        // -------------------------------------------------------------------------
        get id() {
            return this._id;
        }
        // -------------------------------------------------------------------------
        get time() {
            return this._time;
        }
    }
    Spriter.Key = Key;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class KeyMainline extends Spriter.Key {
        constructor() {
            super(...arguments);
            this._boneRefs = [];
            this._objectRefs = [];
        }
        // -------------------------------------------------------------------------
        get boneRefs() {
            return this._boneRefs;
        }
        // -------------------------------------------------------------------------
        addBoneRef(boneRef) {
            this._boneRefs.push(boneRef);
        }
        // -------------------------------------------------------------------------
        get objectRefs() {
            return this._objectRefs;
        }
        // -------------------------------------------------------------------------
        addObjectRef(objectRef) {
            this._objectRefs.push(objectRef);
        }
    }
    Spriter.KeyMainline = KeyMainline;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class KeyTag extends Spriter.Key {
        // -------------------------------------------------------------------------
        get tagsOn() {
            return this._tagsOn;
        }
        // -------------------------------------------------------------------------
        set tagsOn(tagsOn) {
            this._tagsOn = tagsOn;
        }
    }
    Spriter.KeyTag = KeyTag;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class KeyVariable extends Spriter.Key {
        // -------------------------------------------------------------------------
        constructor(id, time, value) {
            super(id, time);
            this._value = value;
        }
        // -------------------------------------------------------------------------
        get value() {
            return this._value;
        }
    }
    Spriter.KeyVariable = KeyVariable;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    let eTimelineType;
    (function (eTimelineType) {
        eTimelineType[eTimelineType["UNKNOWN"] = 0] = "UNKNOWN";
        eTimelineType[eTimelineType["MAIN_LINE"] = 1] = "MAIN_LINE";
        eTimelineType[eTimelineType["TIME_LINE"] = 2] = "TIME_LINE";
        eTimelineType[eTimelineType["SOUND_LINE"] = 3] = "SOUND_LINE";
        eTimelineType[eTimelineType["EVENT_LINE"] = 4] = "EVENT_LINE";
        eTimelineType[eTimelineType["TAG_LINE"] = 5] = "TAG_LINE";
        eTimelineType[eTimelineType["VAR_LINE"] = 6] = "VAR_LINE";
    })(eTimelineType = Spriter.eTimelineType || (Spriter.eTimelineType = {}));
    class Baseline extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name = null) {
            super(id, name);
            this._type = eTimelineType.UNKNOWN;
        }
        // -------------------------------------------------------------------------
        get type() {
            return this._type;
        }
        // -------------------------------------------------------------------------
        set type(type) {
            this._type = type;
        }
        // -------------------------------------------------------------------------
        get keys() {
            return this._keys;
        }
        // -------------------------------------------------------------------------
        add(key) {
            if (this._keys === null || this._keys === undefined) {
                this._keys = [];
            }
            this._keys.push(key);
        }
        // -------------------------------------------------------------------------
        at(index, loop = true) {
            if (index < 0) {
                return null;
            }
            var length = this._keys.length;
            if (index >= length) {
                if (loop) {
                    index = index % length;
                }
                else {
                    index = length - 1;
                }
            }
            return this._keys[index];
        }
    }
    Spriter.Baseline = Baseline;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    // -------------------------------------------------------------------------
    function linear(a, b, t) {
        return ((b - a) * t) + a;
    }
    Spriter.linear = linear;
    // -------------------------------------------------------------------------
    function quadratic(a, b, c, t) {
        return linear(linear(a, b, t), linear(b, c, t), t);
    }
    Spriter.quadratic = quadratic;
    // -------------------------------------------------------------------------
    function cubic(a, b, c, d, t) {
        return linear(quadratic(a, b, c, t), quadratic(b, c, d, t), t);
    }
    Spriter.cubic = cubic;
    // -------------------------------------------------------------------------
    function quartic(a, b, c, d, e, t) {
        return linear(cubic(a, b, c, d, t), cubic(b, c, d, e, t), t);
    }
    Spriter.quartic = quartic;
    // -------------------------------------------------------------------------
    function quintic(a, b, c, d, e, f, t) {
        return linear(quartic(a, b, c, d, e, t), quartic(b, c, d, e, f, t), t);
    }
    Spriter.quintic = quintic;
    // -------------------------------------------------------------------------
    // B(t) = (1  t)^3 * P0 + 3(1  t)^2 * t * P1 + 3(1  t) *  t^2 * P2 + t^3 * P3  , 0  t  1.
    function bezierCoord(p1, p2, t) {
        // p0 = 0, p3 = 1
        var p0 = 0;
        var p3 = 1;
        var u = 1 - t;
        var t2 = t * t;
        var u2 = u * u;
        var u3 = u2 * u;
        var t3 = t2 * t;
        return /*u3 * p0*/ 0 + 3 * u2 * t * p1 + 3 * u * t2 * p2 + t3 * p3;
    }
    // -------------------------------------------------------------------------
    function bezier(p1x, p1y, p2x, p2y, t) {
        var epsilon = 0.001;
        var maxIterations = 10;
        // binary search
        //establish bounds
        var lower = 0;
        var upper = 1;
        var percent = (upper + lower) / 2;
        //initial x
        var x = bezierCoord(p1x, p2x, percent);
        //loop until returned x - t is less than epsilon
        var iterations = 0;
        while (Math.abs(t - x) > epsilon && iterations < maxIterations) {
            if (t > x) {
                lower = percent;
            }
            else {
                upper = percent;
            }
            percent = (upper + lower) / 2;
            x = bezierCoord(p1x, p2x, percent);
            ++iterations;
        }
        //we're within tolerance of the desired x value. Return the y value.
        return bezierCoord(p1y, p2y, percent);
    }
    Spriter.bezier = bezier;
    // -------------------------------------------------------------------------
    function angleLinear(angleA, angleB, spin, t) {
        // no spin
        if (spin === 0) {
            return angleA;
        }
        // spin left
        if (spin > 0) {
            if (angleB > angleA) {
                angleB -= 360;
            }
        }
        else {
            if (angleB < angleA) {
                angleB += 360;
            }
        }
        return this.linear(angleA, angleB, t);
    }
    Spriter.angleLinear = angleLinear;
})(Spriter || (Spriter = {}));
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class Variable extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name, type, defaultValue) {
            super(id, name);
            this._type = type;
            this._default = defaultValue;
            this.reset();
        }
        // -------------------------------------------------------------------------
        clone() {
            return new Variable(this.id, this.name, this.type, this._default);
        }
        // -------------------------------------------------------------------------
        reset() {
            this.value = this._default;
        }
        // -------------------------------------------------------------------------
        get type() {
            return this._type;
        }
        // -------------------------------------------------------------------------
        get value() {
            return this._value;
        }
        // -------------------------------------------------------------------------
        set value(value) {
            if (this._type === 0 /* INT */) {
                this._value = Math.floor(value);
            }
            else {
                this._value = value;
            }
        }
        // -------------------------------------------------------------------------
        get int() {
            return this._value;
        }
        // -------------------------------------------------------------------------
        get float() {
            return this._value;
        }
        // -------------------------------------------------------------------------
        get string() {
            return this._value;
        }
    }
    Spriter.Variable = Variable;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Varline extends Spriter.Baseline {
        // -------------------------------------------------------------------------
        constructor(id, varDefId) {
            super(id, null);
            this._varDefId = varDefId;
            this.type = Spriter.eTimelineType.VAR_LINE;
        }
        // -------------------------------------------------------------------------
        get varDefId() {
            return this._varDefId;
        }
    }
    Spriter.Varline = Varline;
})(Spriter || (Spriter = {}));
/// <reference path="Item.ts" />
var Spriter;
(function (Spriter) {
    class ObjectInfo extends Spriter.Item {
        // -------------------------------------------------------------------------
        constructor(id, name, type, width, height, pivotX, pivotY) {
            super(id, name);
            this._type = type;
            this._width = width;
            this._height = height;
            this._pivotX = pivotX;
            this._pivotY = pivotY;
        }
        // -------------------------------------------------------------------------
        get type() {
            return this._type;
        }
        // -------------------------------------------------------------------------
        get width() {
            return this._width;
        }
        // -------------------------------------------------------------------------
        get height() {
            return this._height;
        }
        // -------------------------------------------------------------------------
        get pivotX() {
            return this._pivotX;
        }
        // -------------------------------------------------------------------------
        get pivotY() {
            return this._pivotY;
        }
    }
    Spriter.ObjectInfo = ObjectInfo;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Types {
        // -------------------------------------------------------------------------
        static getObjectTypeForName(typeName) {
            var type = Types.nameToObjectType[typeName];
            if (type === undefined) {
                console.error("Unknown type of object: " + typeName);
            }
            return type;
        }
        // -------------------------------------------------------------------------
        static getCurveTypeForName(typeName) {
            var type = Types.nameToCurveType[typeName];
            if (type === undefined) {
                console.error("Unknown type of curve: " + typeName);
            }
            return type;
        }
        // -------------------------------------------------------------------------
        static getVariableTypeForName(typeName) {
            var type = Types.nameToVariableType[typeName];
            if (type === undefined) {
                console.error("Unknown type of variable: " + typeName);
            }
            return type;
        }
    }
    Types.nameToObjectType = {
        "sprite": 0 /* SPRITE */,
        "bone": 1 /* BONE */,
        "box": 2 /* BOX */,
        "point": 3 /* POINT */,
        "sound": 4 /* SOUND */
    };
    Types.nameToCurveType = {
        "instant": 1 /* INSTANT */,
        "linear": 0 /* LINEAR */,
        "quadratic": 2 /* QUADRATIC */,
        "cubic": 3 /* CUBIC */,
        "quartic": 4 /* QUARTIC */,
        "quintic": 5 /* QUINTIC */,
        "bezier": 6 /* BEZIER */
    };
    Types.nameToVariableType = {
        "int": 0 /* INT */,
        "float": 1 /* FLOAT */,
        "string": 2 /* STRING */
    };
    Spriter.Types = Types;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Ref {
        // -------------------------------------------------------------------------
        constructor(id, parent, timeline, key, z = 0) {
            this.id = id;
            this.parent = parent;
            this.timeline = timeline;
            this.key = key;
            this.z = z;
        }
    }
    Spriter.Ref = Ref;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Timeline extends Spriter.Baseline {
        // -------------------------------------------------------------------------
        constructor(id, name, type = 0 /* SPRITE */, objectRef = -1) {
            super(id, name);
            this.type = Spriter.eTimelineType.TIME_LINE;
            this._objectType = type;
            this._objectRef = objectRef;
        }
        // -------------------------------------------------------------------------
        get objectType() {
            return this._objectType;
        }
        // -------------------------------------------------------------------------
        get objectRef() {
            return this._objectRef;
        }
    }
    Spriter.Timeline = Timeline;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class KeyTimeline extends Spriter.Key {
        // -------------------------------------------------------------------------
        constructor(id, time, spin) {
            super(id, time);
            this._info = new Spriter.SpatialInfo();
            this._spin = spin;
            this.setCurve(0 /* LINEAR */);
        }
        // -------------------------------------------------------------------------
        setCurve(curveType, c1 = 0, c2 = 0, c3 = 0, c4 = 0) {
            this._curveType = curveType;
            this._c1 = c1;
            this._c2 = c2;
            this._c3 = c3;
            this._c4 = c4;
        }
        // -------------------------------------------------------------------------
        get spin() {
            return this._spin;
        }
        // -------------------------------------------------------------------------
        get curveType() {
            return this._curveType;
        }
        // -------------------------------------------------------------------------
        get c1() {
            return this._c1;
        }
        // -------------------------------------------------------------------------
        get c2() {
            return this._c2;
        }
        // -------------------------------------------------------------------------
        get c3() {
            return this._c3;
        }
        // -------------------------------------------------------------------------
        get c4() {
            return this._c4;
        }
        // -------------------------------------------------------------------------
        get info() {
            return this._info;
        }
    }
    Spriter.KeyTimeline = KeyTimeline;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class SpatialInfo {
        constructor() {
            this.x = 0;
            this.y = 0;
            this.scaleX = 1;
            this.scaleY = 1;
            this.pivotX = 0;
            this.pivotY = 0;
            this.alpha = 1;
            this.angle = 0;
        }
    }
    Spriter.SpatialInfo = SpatialInfo;
})(Spriter || (Spriter = {}));
/// <reference path="KeyTimeline.ts" />
var Spriter;
(function (Spriter) {
    class KeyObject extends Spriter.KeyTimeline {
        // -------------------------------------------------------------------------
        setFolderAndFile(folder, file) {
            this._folder = folder;
            this._file = file;
        }
        // -------------------------------------------------------------------------
        get folder() {
            return this._folder;
        }
        // -------------------------------------------------------------------------
        get file() {
            return this._file;
        }
    }
    Spriter.KeyObject = KeyObject;
})(Spriter || (Spriter = {}));
/// <reference path="KeyTimeline.ts" />
var Spriter;
(function (Spriter) {
    class KeyBone extends Spriter.KeyTimeline {
    }
    Spriter.KeyBone = KeyBone;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class Loader {
        // -------------------------------------------------------------------------
        constructor(game, assetsPath) {
            this._game = game;
            if (assetsPath) {
                this._assetsPath = assetsPath;
                this._loader = new Phaser.Loader(game);
            }
        }
        destroy() {
            this._game = null;
            this._spriter = null;
            this._fileType = null;
            this._loader = null;
            this._assetsPath = null;
        }
        // -------------------------------------------------------------------------
        load(file) {
            this._spriter = new Spriter.Spriter();
            this._fileType = file.getType();
            // folders and files
            var folders = file.getNodes("folder");
            this.loadFolders(this._spriter, folders);
            folders.processed();
            // tags
            var tags = file.getNodes("tag_list");
            this.loadTags(this._spriter, tags);
            tags.processed();
            // entity
            var entities = file.getNodes("entity");
            this.loadEntities(this._spriter, entities);
            entities.processed();
            if (this._loader) {
                this._loader.start();
            }
            return this._spriter;
        }
        // -------------------------------------------------------------------------
        loadFolders(spriter, folders) {
            // through all folders
            for (var i = 0; i < folders.length(); i++) {
                var folder = folders.getFolder(i);
                // images in folder - ignore sounds
                var files = folders.getChildNodes(i, "file");
                this.loadFiles(folder, files);
                files.processed();
                // add folder to spriter object
                spriter.addFolder(folder);
            }
        }
        // -------------------------------------------------------------------------
        loadFiles(folder, files) {
            for (var f = 0; f < files.length(); f++) {
                var file = files.getFile(f);
                // null is returned if file is not image but sound
                if (file !== null) {
                    if (this._loader && file.isEmpty !== true) {
                        this._loader.image(file.name, this._assetsPath + file.name + ".svg@2.png");
                    }
                    folder.addFile(file);
                }
            }
        }
        // -------------------------------------------------------------------------
        loadTags(spriter, tags) {
            // no tags
            if (tags.length() === 0) {
                return;
            }
            // different structure for json than for xml
            var tagDefs;
            if (this._fileType !== Spriter.eFileType.JSON) {
                tagDefs = tags.getChildNodes(0, "i");
            }
            else {
                tagDefs = tags;
            }
            for (var i = 0; i < tagDefs.length(); i++) {
                var tag = tagDefs.getTag(i);
                spriter.addTag(tag);
            }
            // different structure for json than for xml
            if (this._fileType !== Spriter.eFileType.JSON) {
                tagDefs.processed();
            }
        }
        // -------------------------------------------------------------------------
        loadEntities(spriter, entities) {
            for (var i = 0; i < entities.length(); i++) {
                var entity = entities.getEntity(i);
                // bones, boxes, ...
                var objInfos = entities.getChildNodes(i, "obj_info");
                this.loadObjInfo(entity, objInfos);
                objInfos.processed();
                // character maps
                var charMaps = entities.getChildNodes(i, "character_map");
                this.loadCharMaps(entity, charMaps);
                charMaps.processed();
                // variable definitions
                var variables = entities.getChildNodes(i, "var_defs");
                this.loadVariables(entity, variables);
                variables.processed();
                // animations
                var animations = entities.getChildNodes(i, "animation");
                this.loadAnimations(entity, animations);
                animations.processed();
                spriter.addEntity(entity);
            }
        }
        // -------------------------------------------------------------------------
        loadObjInfo(entity, objInfos) {
            for (var i = 0; i < objInfos.length(); i++) {
                var objInfo = objInfos.getObjectInfo(i);
                entity.addObjectInfo(objInfo);
            }
        }
        // -------------------------------------------------------------------------
        loadCharMaps(entity, charMaps) {
            for (var i = 0; i < charMaps.length(); i++) {
                var charMap = charMaps.getCharMap(i);
                var charMapEntries = charMaps.getChildNodes(i, "map");
                this.loadCharMapEntries(charMap, charMapEntries);
                charMapEntries.processed();
                entity.addCharMap(charMap);
            }
        }
        // -------------------------------------------------------------------------
        loadCharMapEntries(charMap, charMapEntries) {
            for (var i = 0; i < charMapEntries.length(); i++) {
                charMapEntries.getCharMapEntry(i, charMap, this._spriter);
            }
        }
        // -------------------------------------------------------------------------
        loadVariables(entity, variables) {
            // no variables
            if (variables.length() === 0) {
                return;
            }
            // different structure for json than for xml
            var varDefs;
            if (this._fileType !== Spriter.eFileType.JSON) {
                varDefs = variables.getChildNodes(0, "i");
            }
            else {
                varDefs = variables;
            }
            for (var i = 0; i < varDefs.length(); i++) {
                var varDef = varDefs.getVariable(i);
                entity.addVariable(varDef);
            }
            // different structure for json than for xml
            if (this._fileType !== Spriter.eFileType.JSON) {
                varDefs.processed();
            }
        }
        // -------------------------------------------------------------------------
        loadAnimations(entity, animations) {
            for (var i = 0; i < animations.length(); i++) {
                var animation = animations.getAnimation(i);
                // main line keys
                var mainlines = animations.getChildNodes(i, "mainline");
                this.loadMainline(animation, mainlines);
                mainlines.processed();
                // timelines
                var timelines = animations.getChildNodes(i, "timeline");
                this.loadTimelines(animation, timelines);
                timelines.processed();
                // sound lines
                var soundlines = animations.getChildNodes(i, "soundline");
                this.loadSoundlines(animation, soundlines);
                soundlines.processed();
                // event lines
                var eventlines = animations.getChildNodes(i, "eventline");
                this.loadEventlines(animation, eventlines);
                eventlines.processed();
                // get meta tag
                var meta = animations.getChildNodes(i, "meta");
                if (meta.length() > 0) {
                    // var lines
                    // OMG - typo in attribute name in JSOUN export... what the hell! TODO - remove when corrected
                    var varlines = meta.getChildNodes(0, (this._fileType !== Spriter.eFileType.JSON) ? "varline" : "valline");
                    this.loadVarlines(entity, animation, varlines);
                    varlines.processed();
                    // tag lines
                    var taglines = meta.getChildNodes(0, "tagline");
                    this.loadTaglines(animation, taglines);
                    taglines.processed();
                }
                meta.processed();
                // add completely built animation to entity
                entity.addAnimation(animation);
            }
        }
        // -------------------------------------------------------------------------
        loadMainline(animation, mainlines) {
            var mainline = mainlines.getMainline(0);
            mainline.type = Spriter.eTimelineType.MAIN_LINE;
            var mainlineKeys = mainlines.getChildNodes(0, "key");
            this.loadMainlineKeys(mainline, mainlineKeys);
            mainlineKeys.processed();
            animation.mainline = mainline;
        }
        // -------------------------------------------------------------------------
        loadMainlineKeys(mainline, mainlineKeys) {
            for (var i = 0; i < mainlineKeys.length(); i++) {
                var mainLineKey = mainlineKeys.getMainlineKey(i);
                // load bone refs
                var boneRefs = mainlineKeys.getChildNodes(i, "bone_ref");
                for (var b = 0; b < boneRefs.length(); b++) {
                    mainLineKey.addBoneRef(boneRefs.getRef(b));
                }
                boneRefs.processed();
                // load sprite refs (object refs)
                var spriteRefs = mainlineKeys.getChildNodes(i, "object_ref");
                for (var s = 0; s < spriteRefs.length(); s++) {
                    mainLineKey.addObjectRef(spriteRefs.getRef(s));
                }
                spriteRefs.processed();
                mainline.add(mainLineKey);
            }
        }
        // -------------------------------------------------------------------------
        loadTimelines(animation, aTimelines) {
            for (var i = 0; i < aTimelines.length(); i++) {
                var timeline = aTimelines.getTimeline(i);
                var keys = aTimelines.getChildNodes(i, "key");
                this.loadTimelineKeys(timeline, keys);
                keys.processed();
                animation.addTimeline(timeline);
            }
        }
        // -------------------------------------------------------------------------
        loadTimelineKeys(aTimeline, aKeys) {
            for (var i = 0; i < aKeys.length(); i++) {
                var key = aKeys.getTimelineKey(i, this._spriter);
                aTimeline.add(key);
            }
        }
        // -------------------------------------------------------------------------
        loadSoundlines(animation, soundlines) {
            for (var i = 0; i < soundlines.length(); i++) {
                var soundline = soundlines.getSoundline(i);
                soundline.type = Spriter.eTimelineType.SOUND_LINE;
                var keys = soundlines.getChildNodes(i, "key");
                this.loadKeys(soundline, keys);
                keys.processed();
                animation.addLine(soundline);
            }
        }
        // -------------------------------------------------------------------------
        loadKeys(timeline, keys) {
            for (var i = 0; i < keys.length(); i++) {
                var key = keys.getKey(i);
                timeline.add(key);
            }
        }
        // -------------------------------------------------------------------------
        loadEventlines(animation, eventlines) {
            for (var i = 0; i < eventlines.length(); i++) {
                var eventline = eventlines.getEventline(i);
                eventline.type = Spriter.eTimelineType.EVENT_LINE;
                var keys = eventlines.getChildNodes(i, "key");
                this.loadKeys(eventline, keys);
                keys.processed();
                animation.addLine(eventline);
            }
        }
        // -------------------------------------------------------------------------
        loadTaglines(animation, taglines) {
            for (var i = 0; i < taglines.length(); i++) {
                var tagline = taglines.getTagline(i);
                tagline.type = Spriter.eTimelineType.TAG_LINE;
                var keys = taglines.getChildNodes(i, "key");
                this.loadTagKeys(tagline, keys);
                keys.processed();
                animation.addLine(tagline);
            }
        }
        // -------------------------------------------------------------------------
        loadTagKeys(tagline, keys) {
            for (var i = 0; i < keys.length(); i++) {
                var key = keys.getTagKey(i);
                var tagChangeElements = keys.getChildNodes(i, "tag");
                var tagChanges = tagChangeElements.getTagChanges(this._spriter);
                tagChangeElements.processed();
                key.tagsOn = tagChanges;
                tagline.add(key);
            }
        }
        // -------------------------------------------------------------------------
        loadVarlines(entity, animation, varlines) {
            for (var i = 0; i < varlines.length(); i++) {
                var varline = varlines.getVarline(i);
                var type = entity.getVariableById(varline.varDefId).type;
                var keys = varlines.getChildNodes(i, "key");
                this.loadVariableKeys(varline, keys, type);
                keys.processed();
                animation.addLine(varline);
            }
        }
        // -------------------------------------------------------------------------
        loadVariableKeys(varline, keys, type) {
            for (var i = 0; i < keys.length(); i++) {
                var key = keys.getVariableKey(i, type);
                varline.add(key);
            }
        }
    }
    Spriter.Loader = Loader;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter_1) {
    class Spriter {
        // -------------------------------------------------------------------------
        constructor() {
            this._folders = new Spriter_1.IdNameMap();
            this._tags = new Spriter_1.IdNameMap();
            this._entities = new Spriter_1.IdNameMap();
        }
        // -------------------------------------------------------------------------
        addFolder(folder) {
            this._folders.add(folder, folder.id, folder.name);
        }
        // -------------------------------------------------------------------------
        getFolderById(id) {
            return this._folders.getById(id);
        }
        // -------------------------------------------------------------------------
        getFolderByName(name) {
            return this._folders.getByName(name);
        }
        // -------------------------------------------------------------------------
        addEntity(entity) {
            this._entities.add(entity, entity.id, entity.name);
        }
        // -------------------------------------------------------------------------
        getEntityById(id) {
            return this._entities.getById(id);
        }
        // -------------------------------------------------------------------------
        getEntityByName(name) {
            return this._entities.getByName(name);
        }
        // -------------------------------------------------------------------------
        addTag(tag) {
            this._tags.add(tag, tag.id, tag.name);
        }
        // -------------------------------------------------------------------------
        getTagById(id) {
            return this._tags.getById(id);
        }
        // -------------------------------------------------------------------------
        getTagByName(name) {
            return this._tags.getByName(name);
        }
        // -------------------------------------------------------------------------
        get tagsLength() {
            return this._tags.length;
        }
    }
    Spriter_1.Spriter = Spriter;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class SpriterBone {
        // -------------------------------------------------------------------------
        constructor() {
            this.timeline = -1;
            this.timelineKey = -1;
            this.transformed = new Spriter.SpatialInfo();
        }
        // -------------------------------------------------------------------------
        setOn(on) {
            this._on = on;
        }
        // -------------------------------------------------------------------------
        get on() {
            return this._on;
        }
        // -------------------------------------------------------------------------
        setKey(entity, animation, timelineId, keyId) {
            this.timeline = timelineId;
            this.timelineKey = keyId;
            var timeline = animation.getTimelineById(timelineId);
            this.name = timeline.name;
            this.objectInfo = (timeline.objectRef === -1) ? null : entity.getObjectInfoById(timeline.objectRef);
            var keyFrom = timeline.at(keyId);
            // in the end loop to first key. If animation is not looping, then repeat last key
            var keyTo = (timeline.at(keyId + 1, animation.loopType !== Spriter.eAnimationLooping.NO_LOOPING));
            this.key = keyFrom;
            this.timeFrom = keyFrom.time;
            this.timeTo = keyTo.time;
            // if loop to key 0
            if (this.timeTo < this.timeFrom) {
                this.timeTo = animation.length;
            }
            this.from = keyFrom.info;
            this.to = keyTo.info;
            // create update mask
            this.updateMask = 0;
            if (Math.abs(this.from.x - this.to.x) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_X;
            }
            if (Math.abs(this.from.y - this.to.y) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_Y;
            }
            if (Math.abs(this.from.scaleX - this.to.scaleX) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_SCALE_X;
            }
            if (Math.abs(this.from.scaleY - this.to.scaleY) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_SCALE_Y;
            }
            if (Math.abs(this.from.pivotX - this.to.pivotX) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_PIVOT_X;
            }
            if (Math.abs(this.from.pivotY - this.to.pivotY) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_PIVOT_Y;
            }
            if (Math.abs(this.from.alpha - this.to.alpha) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_ALPHA;
            }
            if (Math.abs(this.from.angle - this.to.angle) > 0.001) {
                this.updateMask += SpriterBone.UPDATE_ANGLE;
            }
            // init data
            this.transformed.x = this.from.x;
            this.transformed.y = this.from.y;
            this.transformed.scaleX = this.from.scaleX;
            this.transformed.scaleY = this.from.scaleY;
            this.transformed.pivotX = this.from.pivotX;
            this.transformed.pivotY = this.from.pivotY;
            this.transformed.angle = this.from.angle;
            this.transformed.alpha = this.from.alpha;
        }
        // -------------------------------------------------------------------------
        tween(time) {
            // calculate normalized time
            //var t = Phaser.Math.clamp((time - this.timeFrom) / (this.timeTo - this.timeFrom), 0, 1);
            var t = (this.updateMask > 0) ? this.getTweenTime(time) : 0;
            this.transformed.x = (this.updateMask & SpriterBone.UPDATE_X) > 0 ?
                Spriter.linear(this.from.x, this.to.x, t) : this.from.x;
            this.transformed.y = (this.updateMask & SpriterBone.UPDATE_Y) > 0 ?
                Spriter.linear(this.from.y, this.to.y, t) : this.from.y;
            this.transformed.scaleX = (this.updateMask & SpriterBone.UPDATE_SCALE_X) > 0 ?
                Spriter.linear(this.from.scaleX, this.to.scaleX, t) : this.from.scaleX;
            this.transformed.scaleY = (this.updateMask & SpriterBone.UPDATE_SCALE_Y) > 0 ?
                Spriter.linear(this.from.scaleY, this.to.scaleY, t) : this.from.scaleY;
            this.transformed.pivotX = (this.updateMask & SpriterBone.UPDATE_PIVOT_X) > 0 ?
                Spriter.linear(this.from.pivotX, this.to.pivotX, t) : this.from.pivotX;
            this.transformed.pivotY = (this.updateMask & SpriterBone.UPDATE_PIVOT_Y) > 0 ?
                Spriter.linear(this.from.pivotY, this.to.pivotY, t) : this.from.pivotY;
            this.transformed.alpha = (this.updateMask & SpriterBone.UPDATE_ALPHA) > 0 ?
                Spriter.linear(this.from.alpha, this.to.alpha, t) : this.from.alpha;
            this.transformed.angle = (this.updateMask & SpriterBone.UPDATE_ANGLE) > 0 ?
                Spriter.angleLinear(this.from.angle, this.to.angle, this.key.spin, t) : this.from.angle;
        }
        // -------------------------------------------------------------------------
        update(parent) {
            this.transformed.angle *= Phaser.Math.sign(parent.scaleX) * Phaser.Math.sign(parent.scaleY);
            this.transformed.angle += parent.angle;
            this.transformed.scaleX *= parent.scaleX;
            this.transformed.scaleY *= parent.scaleY;
            this.scalePosition(parent.scaleX, parent.scaleY);
            this.rotatePosition(parent.angle);
            this.translatePosition(parent.x, parent.y);
            this.transformed.alpha *= parent.alpha;
        }
        // -------------------------------------------------------------------------
        scalePosition(parentScaleX, parentScaleY) {
            this.transformed.x *= parentScaleX;
            this.transformed.y *= parentScaleY;
        }
        // -------------------------------------------------------------------------
        rotatePosition(parentAngle) {
            var x = this.transformed.x;
            var y = this.transformed.y;
            if (x !== 0 || y !== 0) {
                var rads = parentAngle * (Math.PI / 180);
                var cos = Math.cos(rads);
                var sin = Math.sin(rads);
                this.transformed.x = x * cos - y * sin;
                this.transformed.y = x * sin + y * cos;
            }
        }
        // -------------------------------------------------------------------------
        translatePosition(parentX, parentY) {
            this.transformed.x += parentX;
            this.transformed.y += parentY;
        }
        // -------------------------------------------------------------------------
        getTweenTime(time) {
            if (this.key.curveType === 1 /* INSTANT */) {
                return 0;
            }
            var t = Phaser.Math.clamp((time - this.timeFrom) / (this.timeTo - this.timeFrom), 0, 1);
            switch (this.key.curveType) {
                case 0 /* LINEAR */:
                    return t;
                case 2 /* QUADRATIC */:
                    return Spriter.quadratic(0, this.key.c1, 1, t);
                case 3 /* CUBIC */:
                    return Spriter.cubic(0, this.key.c1, this.key.c2, 1, t);
                case 4 /* QUARTIC */:
                    return Spriter.quartic(0, this.key.c1, this.key.c2, this.key.c3, 1, t);
                case 5 /* QUINTIC */:
                    return Spriter.quintic(0, this.key.c1, this.key.c2, this.key.c3, this.key.c4, 1, t);
                case 6 /* BEZIER */:
                    return Spriter.bezier(this.key.c1, this.key.c2, this.key.c3, this.key.c4, t);
            }
            return 0;
        }
    }
    SpriterBone.UPDATE_X = 1;
    SpriterBone.UPDATE_Y = 2;
    SpriterBone.UPDATE_SCALE_X = 4;
    SpriterBone.UPDATE_SCALE_Y = 8;
    SpriterBone.UPDATE_PIVOT_X = 16;
    SpriterBone.UPDATE_PIVOT_Y = 32;
    SpriterBone.UPDATE_ANGLE = 64;
    SpriterBone.UPDATE_ALPHA = 128;
    Spriter.SpriterBone = SpriterBone;
})(Spriter || (Spriter = {}));
var Spriter;
(function (Spriter) {
    class SpriterGroup extends Phaser.Group {
        // -------------------------------------------------------------------------
        constructor(game, spriter, texutreKey, entityName, animation, animationSpeedPercent, isUsingAtlas) {
            super(game, null);
            // onLoop(SpriterGroup);
            this.onLoop = new Phaser.Signal();
            // onFinish(SpriterGroup);
            this.onFinish = new Phaser.Signal();
            // onSound(SpriterGroup, string); // string for line name which equals soud name without extension
            this.onSound = new Phaser.Signal();
            // onEvent(SpriterGroup, string); // string for line name which equals event name
            this.onEvent = new Phaser.Signal();
            // onTagChange(SpriterGroup, string, boolean); // string for tag name, boolean for change (true = set / false = unset)
            this.onTagChange = new Phaser.Signal();
            // onVariableSet(SpriterGroup, Variable); // Variable is Spriter variable def with access to value
            this.onVariableSet = new Phaser.Signal();
            // onBoxUpdated(SpriterGroup, SpriterObject);
            this.onBoxUpdated = new Phaser.Signal();
            // onPointUpdated(SpriterGroup, SpriterObject);
            this.onPointUpdated = new Phaser.Signal();
            this._mainlineStepper = new Spriter.LineStepper();
            this._lineSteppers = [];
            this._lineSteppersCount = 0;
            this._bones = [];
            this._objects = [];
            this._tags = 0; // up to 32 tags - 1 per bit
            this._vars = [];
            this._paused = false;
            this._spriter = spriter;
            this._entityName = entityName;
            this._entity = spriter.getEntityByName(entityName);
            this._textureKey = texutreKey;
            this._isUsingAtlas = isUsingAtlas ? isUsingAtlas : false;
            this._root = new Spriter.SpatialInfo();
            // clone variables
            for (var i = 0; i < this._entity.variablesLength; i++) {
                this._vars[i] = this._entity.getVariableById(i).clone();
            }
            // create charmap stack
            this._charMapStack = new Spriter.CharMapStack(this._entity);
            // set animation speed
            if (animationSpeedPercent === undefined) {
                animationSpeedPercent = 100;
            }
            this.setAnimationSpeedPercent(animationSpeedPercent);
            // set animation
            if (animation === undefined || animation === null) {
                // set first animation
                this.playAnimationById(0);
            }
            else if (typeof animation === "number") {
                this.playAnimationById(animation);
            }
            else {
                this.playAnimationByName(animation);
            }
        }
        // -------------------------------------------------------------------------
        get spriter() {
            return this._spriter;
        }
        // -------------------------------------------------------------------------
        get entity() {
            return this._entity;
        }
        // -------------------------------------------------------------------------
        get charMapStack() {
            return this._charMapStack;
        }
        // -------------------------------------------------------------------------
        get paused() {
            return this._paused;
        }
        // -------------------------------------------------------------------------
        set paused(paused) {
            this._paused = paused;
        }
        // -------------------------------------------------------------------------
        get animationsCount() {
            return this._entity.animationsLength;
        }
        // -------------------------------------------------------------------------
        get currentAnimationName() {
            return this._animationName;
        }
        // -------------------------------------------------------------------------
        pushCharMap(charMapName) {
            this._charMapStack.push(charMapName);
            this.resetSprites();
        }
        // -------------------------------------------------------------------------
        removeCharMap(charMapName) {
            this._charMapStack.remove(charMapName);
            this.resetSprites();
        }
        // -------------------------------------------------------------------------
        clearCharMaps() {
            this._charMapStack.reset();
            this.resetSprites();
        }
        // -------------------------------------------------------------------------
        resetSprites() {
            for (var i = 0; i < this._objects.length; i++) {
                this._objects[i].resetFile();
            }
        }
        // -------------------------------------------------------------------------
        isTagOn(tagName) {
            return this.isTagOnById(this._spriter.getTagByName(tagName).id);
        }
        // -------------------------------------------------------------------------
        isTagOnById(tagId) {
            return (this._tags & (1 << tagId)) > 0;
        }
        // -------------------------------------------------------------------------
        getVariable(varName) {
            return this.getVariableById(this._entity.getVariableByName(varName).id);
        }
        // -------------------------------------------------------------------------
        getVariableById(varId) {
            return this._vars[varId];
        }
        // -------------------------------------------------------------------------
        getObject(objectName) {
            for (var i = 0; i < this._objects.length; i++) {
                var object = this._objects[i];
                if (object.name === objectName) {
                    return object;
                }
            }
            return null;
        }
        // -------------------------------------------------------------------------
        setAnimationSpeedPercent(animationSpeedPercent = 100) {
            this._animationSpeed = animationSpeedPercent / 100;
        }
        // -------------------------------------------------------------------------
        playAnimationById(animationId) {
            var animation = this._entity.getAnimationById(animationId);
            if (animation === undefined || animation === null) {
                console.warn("Animation " + animationId + " for entity " + this._entityName + " does not exist!");
                return;
            }
            this.playAnimation(animation);
        }
        // -------------------------------------------------------------------------
        playAnimationByName(animationName) {
            var animation = this._entity.getAnimationByName(animationName);
            if (animation === undefined || animation === null) {
                console.warn("Animation " + animationName + " for entity " + this._entityName + " does not exist!");
                return;
            }
            this.playAnimation(animation);
        }
        // -------------------------------------------------------------------------
        playAnimation(animation) {
            this._animationName = animation.name;
            this._animation = animation;
            this._finished = false;
            // reset time to beginning of animation and find first from and to keys
            this._mainlineStepper.reset();
            this._mainlineStepper.line = this._animation.mainline;
            this._time = 0;
            // reset all additional time lines (soundline, varline, tagline, eventline)
            this.resetLines();
            // reset tags
            this._tags = 0;
            // reset variables to defaults
            for (var i = 0; i < this._vars.length; i++) {
                this._vars[i].reset();
            }
            // create bones and sprites - based on data in mainLine key 0
            this.loadKeys(this._animation.mainline.at(0), true);
            // first update - to set correct positions
            this.updateCharacter();
        }
        // -------------------------------------------------------------------------
        resetLines() {
            // reset steppers
            this._lineSteppersCount = 0;
            // go through all lines (sounds, events, tags, vars)
            for (var i = 0; i < this._animation.linesLength; i++) {
                var line = this._animation.getLineById(i);
                // if not enough line steppers in array, add new one
                if (this._lineSteppersCount >= this._lineSteppers.length) {
                    this._lineSteppers[this._lineSteppersCount] = new Spriter.LineStepper();
                }
                // get free stepper
                var stepper = this._lineSteppers[this._lineSteppersCount++];
                stepper.reset();
                stepper.line = line;
            }
        }
        // -------------------------------------------------------------------------
        setBones(bones, force = false) {
            // switch off all existing bones
            for (var i = 0; i < this._bones.length; i++) {
                if (this._bones[i] !== undefined) {
                    this._bones[i].setOn(false);
                }
            }
            // go through all bones and add new ones if necessary and activate used ones
            for (var i = 0; i < bones.length; i++) {
                var ref = bones[i];
                // if bone does not exist add it and make active, else make it active only
                if (this._bones[ref.id] === undefined) {
                    var newBone = new Spriter.SpriterBone();
                    newBone.type = 1 /* BONE */;
                    this._bones[ref.id] = newBone;
                }
                var bone = this._bones[ref.id];
                bone.setOn(true);
                bone.parent = ref.parent;
                if (bone.timelineKey !== ref.key || bone.timeline !== ref.timeline || force) {
                    bone.setKey(this._entity, this._animation, ref.timeline, ref.key);
                }
            }
        }
        // -------------------------------------------------------------------------
        setObjects(objects, force = false) {
            // switch off (kill) all existing sprites
            for (var i = 0; i < this._objects.length; i++) {
                if (this._objects[i] !== undefined) {
                    this._objects[i].setOn(false);
                }
            }
            // go through all objects/sprites and add new ones if necessary and activate used ones
            var zChange = false;
            for (var i = 0; i < objects.length; i++) {
                var ref = objects[i];
                var object = null;
                var sprite = null;
                // if sprite does not exist add it and make active, else make it active only
                if (this._objects[ref.id] === undefined) {
                    sprite = new Phaser.Sprite(this.game, 0, 0, this._textureKey);
                    object = new Spriter.SpriterObject(this, sprite, this._isUsingAtlas);
                    this._objects[ref.id] = object;
                    this.add(sprite);
                }
                else {
                    object = this._objects[ref.id];
                    sprite = object.sprite;
                }
                object.parent = ref.parent;
                object.type = this._animation.getTimelineById(ref.timeline).objectType;
                // is it sprite or any other type of object? (box / point)
                if (object.type === 0 /* SPRITE */) {
                    object.setOn(true);
                    if (object.sprite.z !== ref.z) {
                        object.sprite.z = ref.z;
                        zChange = true;
                    }
                }
                else {
                    object.setOn(true, true);
                    // TODO remove - debug
                    //if (object.type === eObjectType.POINT) {
                    //    object.setOn(true);
                    //    object.sprite.frameName = "DebugPoint";
                    //    object.sprite.anchor.set(0.5, 0.5);
                    //} else if (object.type === eObjectType.BOX) {
                    //    object.setOn(true);
                    //    object.sprite.frameName = "DebugBox";
                    //}
                }
                if (object.timelineKey !== ref.key || object.timeline !== ref.timeline || force) {
                    object.setKey(this._entity, this._animation, ref.timeline, ref.key);
                }
            }
            // need to sort sprites?
            if (zChange) {
                this.sort();
            }
        }
        // -------------------------------------------------------------------------
        loadKeys(keyMainline, force = false) {
            this.setBones(keyMainline.boneRefs, force);
            this.setObjects(keyMainline.objectRefs, force);
        }
        // -------------------------------------------------------------------------
        updateAnimation() {
            if (this._paused || this._finished) {
                return;
            }
            var mainlineStepper = this._mainlineStepper;
            // check if in the end of animation and whether to loop or not
            if (this._time > this._animation.length) {
                if (this._animation.loopType === Spriter.eAnimationLooping.NO_LOOPING) {
                    this._time = this._animation.length;
                    this._finished = true;
                }
                else {
                    this._time -= this._animation.length;
                    this.onLoop.dispatch(this);
                }
            }
            // consume all new keys
            var key;
            while ((key = mainlineStepper.step(this._time)) !== null) {
                //console.log("got key at: " + key.time + " time: " + this._time);
                this.loadKeys(key);
                mainlineStepper.lastTime = key.time;
            }
            this.updateCharacter();
            this.updateLines();
            if (this._finished) {
                this.onFinish.dispatch(this);
            }
            this._time += (this.game.time.physicsElapsedMS * this._animationSpeed);
        }
        // -------------------------------------------------------------------------
        updateCharacter() {
            for (var i = 0; i < this._bones.length; i++) {
                var bone = this._bones[i];
                if (bone.on) {
                    var parentSpatial = (bone.parent === -1) ? this._root : this._bones[bone.parent].transformed;
                    bone.tween(this._time);
                    bone.update(parentSpatial);
                }
            }
            for (var i = 0; i < this._objects.length; i++) {
                var object = this._objects[i];
                if (object.on) {
                    var parentSpatial = (object.parent === -1) ? this._root : this._bones[object.parent].transformed;
                    object.tween(this._time);
                    object.update(parentSpatial);
                    if (object.type === 0 /* SPRITE */) {
                        object.updateSprite();
                    }
                    else if (object.type === 2 /* BOX */) {
                        this.onBoxUpdated.dispatch(this, object);
                    }
                    else if (object.type === 3 /* POINT */) {
                        this.onPointUpdated.dispatch(this, object);
                    }
                    //// TODO remove - debug
                    //if (object.type === eObjectType.BOX) {
                    //    var frame = this.game.cache.getFrameByName(this._textureKey, "DebugBox");
                    //    var timeline = this._animation.getTimelineById(object.timeline);
                    //    var objDef = this._spriter.getEntityByName(this._entityName).getObjectInfoById(timeline.objectRef);
                    //    var transformed = object.transformed;
                    //    var objWidth = objDef.width * transformed.scaleX;
                    //    var objHeight = objDef.height * transformed.scaleY;
                    //    object.sprite.scale.set(objWidth / frame.width, objHeight / frame.height);
                    //}
                }
            }
        }
        // -------------------------------------------------------------------------
        updateLines() {
            for (var i = this._lineSteppersCount - 1; i >= 0; i--) {
                var lineStepper = this._lineSteppers[i];
                var line = lineStepper.line;
                var key;
                while ((key = lineStepper.step(this._time)) !== null) {
                    switch (line.type) {
                        case Spriter.eTimelineType.SOUND_LINE:
                            //console.log("sound: " + line.name + " - key: " + key.id + ", time: " + key.time);
                            this.onSound.dispatch(this, line.name);
                            break;
                        case Spriter.eTimelineType.EVENT_LINE:
                            //console.log("event: " + line.name + " - key: " + key.id + ", time: " + key.time);
                            this.onEvent.dispatch(this, line.name);
                            break;
                        case Spriter.eTimelineType.TAG_LINE:
                            var tagsOn = key.tagsOn;
                            var tagChanges = this._tags ^ tagsOn;
                            this._tags = tagsOn;
                            // go through all changes
                            for (var j = 0; j < this._spriter.tagsLength; j++) {
                                var mask = 1 << j;
                                if (tagChanges & mask) {
                                    //console.log("tag change: " + this._spriter.getTagById(j).name + " value: " + ((tagsOn & mask) > 0) + " - key: " + key.id + ", time: " + key.time);
                                    this.onTagChange.dispatch(this, this._spriter.getTagById(j).name, (tagsOn & mask) > 0);
                                }
                            }
                            break;
                        case Spriter.eTimelineType.VAR_LINE:
                            var newVal = key.value;
                            var variable = this._vars[line.varDefId];
                            variable.value = newVal;
                            //console.log("var set: " + variable.name + " value: " + variable.value + " - key: " + key.id + ", time: " + key.time);
                            this.onVariableSet.dispatch(this, variable);
                            break;
                    }
                    lineStepper.lastTime = key.time;
                }
            }
        }
    }
    Spriter.SpriterGroup = SpriterGroup;
})(Spriter || (Spriter = {}));
/// <reference path="SpriterBone.ts" />
var Spriter;
(function (Spriter) {
    class SpriterObject extends Spriter.SpriterBone {
        // -------------------------------------------------------------------------
        constructor(parent, sprite, isUsingAtlas) {
            super();
            this._spriter = parent.spriter;
            this._charMapStack = parent.charMapStack;
            this._sprite = sprite;
            this._isUsingAtlas = isUsingAtlas;
        }
        // -------------------------------------------------------------------------
        get sprite() {
            return this._sprite;
        }
        // -------------------------------------------------------------------------
        setOn(on, hideSprite = false) {
            super.setOn(on);
            // hide sprite for non-sprite objects
            this._sprite.exists = on && !hideSprite;
            this._sprite.visible = (on && !this._hide && !hideSprite);
        }
        // -------------------------------------------------------------------------
        setKey(entity, animation, timelineId, keyId) {
            super.setKey(entity, animation, timelineId, keyId);
            // set sprite - skip invisible objects - boxes, points
            if (this.type === 0 /* SPRITE */) {
                var spriteKey = this.key;
                var file = this._spriter.getFolderById(spriteKey.folder).getFileById(spriteKey.file);
                this._file = file;
                this.setFile(file);
            }
            else {
                this._file = null;
            }
        }
        // -------------------------------------------------------------------------
        resetFile() {
            if (this.type === 0 /* SPRITE */) {
                this.setFile(this._file);
            }
        }
        // -------------------------------------------------------------------------
        setFile(file) {
            file = this._charMapStack.getFile(file);
            if (file !== null && file.isEmpty !== true) {
                this._hide = false;
                if (this._isUsingAtlas) {
                    this._sprite.frameName = file.name;
                }
                else {
                    this._sprite.loadTexture(file.name);
                }
            }
            else {
                this._hide = true;
                this._sprite.visible = false;
            }
        }
        // -------------------------------------------------------------------------
        updateSprite() {
            var t = this.transformed;
            var s = this.sprite;
            s.position.set(t.x, t.y);
            s.scale.set(t.scaleX, t.scaleY);
            s.anchor.set(t.pivotX, t.pivotY);
            s.alpha = t.alpha;
            s.angle = t.angle;
        }
    }
    Spriter.SpriterObject = SpriterObject;
})(Spriter || (Spriter = {}));
//# sourceMappingURL=spriter.min.js.map